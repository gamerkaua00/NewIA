<!DOCTYPE html>
<html lang="pt-BR" class="h-full w-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, interactive-widget=resizes-content">
    <title>NeuralOS v8.0 - Phi-3.5 Fast</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/12.0.0/marked.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.25.0/full/pyodide.js"></script>
    
    <script type="module">
        // Importa√ß√£o via esm.run que costuma ser mais robusta para exports complexos
        import * as webllm from "https://esm.run/@mlc-ai/web-llm";

        // --- CONFIGURA√á√ÉO ---
        const RENDER_API_URL = "https://neural-api-3vra.onrender.com"; 
        
        // MUDAN√áA: Usando Phi-3.5 Mini. √â mais leve, mais r√°pido e muito inteligente.
        const MODEL_ID = "Phi-3.5-mini-instruct-q4f16_1-MLC";
        const MAX_HISTORY = 6; 

        // --- CONFIGURA√á√ÉO MANUAL BLINDADA ---
        const appConfig = {
            model_list: [
                {
                    "model_id": "Phi-3.5-mini-instruct-q4f16_1-MLC",
                    "model_lib_url": "https://raw.githubusercontent.com/mlc-ai/binary-mlc-llm-libs/main/web-llm-build/Phi-3.5-mini-instruct-q4f16_1-MLC/Phi-3.5-mini-instruct-q4f16_1-MLC-webgpu.wasm",
                    "vram_required_MB": 3000,
                    "low_resource_required": true,
                    // Definir o template explicitamente evita erros de infer√™ncia
                    "conv_template": "phi-3", 
                }
            ],
            useIndexedDBCache: true
        };

        // --- ESTADO GLOBAL ---
        let engine = null;
        let chatHistory = [];
        let isOnlineDB = false;
        let availableVoices = [];
        let currentCanvasCode = ""; 
        let pyodideInstance = null;
        
        // --- CONFIGURA√á√ïES DO USU√ÅRIO ---
        let userConfig = {
            name: 'Usu√°rio',
            vibe: 'Assistente Padr√£o',
            ttsEnabled: false,
            voiceIndex: 0,
            amoled: false
        };

        function loadConfigs() {
            try {
                if(localStorage.getItem('neural_user_name')) userConfig.name = localStorage.getItem('neural_user_name');
                if(localStorage.getItem('neural_ai_vibe')) userConfig.vibe = localStorage.getItem('neural_ai_vibe');
                if(localStorage.getItem('neural_tts')) userConfig.ttsEnabled = localStorage.getItem('neural_tts') === 'true';
                if(localStorage.getItem('neural_voice_idx')) userConfig.voiceIndex = parseInt(localStorage.getItem('neural_voice_idx'));
                if(localStorage.getItem('neural_amoled')) userConfig.amoled = localStorage.getItem('neural_amoled') === 'true';
                if(localStorage.getItem('neural_local_db')) localStorage.removeItem('neural_local_db');
            } catch(e) { console.warn("Erro config:", e); }
        }
        loadConfigs();

        const $ = (id) => document.getElementById(id);

        // --- TEMA E UI ---
        function applyTheme() {
            const body = document.body;
            const appContainer = $('main-app-container');
            const inputContainer = $('input-container');
            const inputWrapper = $('input-wrapper');
            const headers = document.querySelectorAll('header');
            const modals = document.querySelectorAll('.modal-bg');
            const inputBox = $('input-box');
            
            if (!body) return;

            if (userConfig.amoled) {
                body.className = "font-sans antialiased bg-black text-gray-200 h-full w-full overflow-hidden flex flex-col";
                if(appContainer) appContainer.className = "flex-1 flex flex-col relative overflow-hidden max-w-md mx-auto w-full h-full shadow-2xl bg-black border-x border-gray-800";
                if(inputContainer) inputContainer.className = "w-full p-4 bg-black z-10 transition-colors shrink-0 border-t border-gray-800";
                if(inputWrapper) inputWrapper.className = "flex items-center gap-2 border p-1.5 pl-2 rounded-full shadow-sm bg-gray-900 border-gray-700";
                headers.forEach(h => h.className = "h-14 backdrop-blur border-b flex items-center justify-between px-4 shrink-0 z-20 transition-colors bg-black/90 border-gray-800");
                modals.forEach(m => m.classList.replace('bg-white', 'bg-gray-900'));
                if(inputBox) {
                    inputBox.classList.remove('text-gray-800', 'placeholder-gray-400');
                    inputBox.classList.add('text-white', 'placeholder-gray-600');
                }
            } else {
                body.className = "font-sans antialiased bg-slate-50 text-slate-800 h-full w-full overflow-hidden flex flex-col";
                if(appContainer) appContainer.className = "flex-1 flex flex-col relative overflow-hidden max-w-md mx-auto w-full h-full shadow-2xl bg-white border-x border-gray-100";
                if(inputContainer) inputContainer.className = "w-full p-4 bg-white z-10 transition-colors shrink-0 border-t border-gray-100";
                if(inputWrapper) inputWrapper.className = "flex items-center gap-2 border p-1.5 pl-2 rounded-full shadow-sm bg-white border-gray-200";
                headers.forEach(h => h.className = "h-14 backdrop-blur border-b flex items-center justify-between px-4 shrink-0 z-20 transition-colors bg-white/90 border-gray-100");
                modals.forEach(m => m.classList.replace('bg-gray-900', 'bg-white'));
                if(inputBox) {
                    inputBox.classList.remove('text-white', 'placeholder-gray-600');
                    inputBox.classList.add('text-gray-800', 'placeholder-gray-400');
                }
            }
        }

        // --- BANCO DE DADOS (RENDER) ---
        const DB = {
            cache: [],
            lastFetch: 0,
            wakeUp: async () => {
                if (!RENDER_API_URL) return false;
                $('status-indicator').innerHTML = '<span class="animate-pulse">‚è≥</span>';
                try {
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 60000); 
                    const res = await fetch(`${RENDER_API_URL}/wake-up`, { signal: controller.signal });
                    clearTimeout(timeoutId);
                    if (res.ok) { 
                        isOnlineDB = true; 
                        $('status-indicator').innerText = "‚óè Nuvem Online";
                        $('status-indicator').className = "text-[10px] text-green-500 font-bold cursor-pointer";
                        return true; 
                    }
                } catch (e) {}
                isOnlineDB = false;
                $('status-indicator').innerText = "‚óè Offline";
                $('status-indicator').className = "text-[10px] text-red-500 font-bold cursor-pointer";
                return false;
            },
            retryConnection: async () => {
                showToast("Conectando √† Nuvem...");
                await DB.wakeUp();
                DB.refreshList();
            },
            sync: async () => {
                if (!isOnlineDB) return [];
                const now = Date.now();
                if (now - DB.lastFetch < 60000 && DB.cache.length > 0) return DB.cache;
                try {
                    const res = await fetch(`${RENDER_API_URL}/memories`);
                    if (res.ok) {
                        DB.cache = await res.json();
                        DB.lastFetch = now;
                        return DB.cache;
                    }
                } catch(e) { console.error("Erro sync", e); }
                return DB.cache || [];
            },
            add: async (text) => {
                if (!isOnlineDB) { showToast("‚ùå Erro: Nuvem desconectada."); return; }
                const entry = { content: text, date: new Date().toISOString() };
                try { 
                    const res = await fetch(`${RENDER_API_URL}/memories`, { 
                        method: 'POST', 
                        headers: {'Content-Type': 'application/json'}, 
                        body: JSON.stringify(entry) 
                    });
                    if (res.ok) {
                        showToast("üíæ Salvo na Nuvem");
                        DB.cache.unshift(entry);
                        DB.refreshList();
                    } else { throw new Error("Erro API"); }
                } catch(e) { showToast("‚ùå Falha ao salvar."); }
            },
            search: async (term) => {
                if (!isOnlineDB) return [];
                const memories = await DB.sync();
                if (!memories.length) return [];
                const queryTokens = term.toLowerCase().split(/\s+/).filter(t => t.length > 3);
                if (queryTokens.length === 0) return [];
                const scored = memories.map(mem => {
                    let score = 0;
                    const contentLower = mem.content.toLowerCase();
                    if (contentLower.includes(term.toLowerCase())) score += 10;
                    queryTokens.forEach(token => { if (contentLower.includes(token)) score += 2; });
                    return { content: mem.content, score };
                });
                return scored.filter(item => item.score > 0).sort((a, b) => b.score - a.score).slice(0, 3).map(item => item.content);
            },
            refreshList: async () => {
                const list = $('memory-list');
                const items = await DB.sync();
                $('mem-count').innerText = items.length;
                list.innerHTML = items.length ? '' : '<div class="text-center text-gray-500 text-xs mt-10">Nuvem Vazia ou Offline</div>';
                const dark = userConfig.amoled;
                items.forEach(item => {
                    const el = document.createElement('div');
                    const bgClass = dark ? 'bg-gray-900 border-gray-800 text-gray-300' : 'bg-white border-gray-100 text-gray-700';
                    el.className = `${bgClass} p-3 rounded-lg border shadow-sm mb-2 text-sm`;
                    el.innerHTML = `<div class="font-medium">${item.content}</div><div class="text-[10px] opacity-60 mt-1">${new Date(item.date).toLocaleDateString()}</div>`;
                    list.appendChild(el);
                });
            }
        };

        // --- √ÅUDIO ---
        function loadVoices() {
            availableVoices = window.speechSynthesis.getVoices();
            const voiceSelect = $('select-voice');
            if(!voiceSelect) return;
            voiceSelect.innerHTML = '';
            const ptVoices = availableVoices.filter(v => v.lang.includes('pt') || v.lang.includes('BR'));
            const voicesToUse = ptVoices.length > 0 ? ptVoices : availableVoices;
            voicesToUse.forEach((voice, index) => {
                const option = document.createElement('option');
                option.value = index; 
                option.textContent = `${voice.name}`;
                if(index === userConfig.voiceIndex) option.selected = true;
                voiceSelect.appendChild(option);
            });
        }
        window.speechSynthesis.onvoiceschanged = loadVoices;

        function speak(text) {
            if (!userConfig.ttsEnabled || !text) return;
            const cleanText = text.replace(/[*#_\[\]`]/g, '').replace(/https?:\/\/\S+/g, 'link');
            const utterance = new SpeechSynthesisUtterance(cleanText);
            const ptVoices = availableVoices.filter(v => v.lang.includes('pt') || v.lang.includes('BR'));
            const voicesList = ptVoices.length > 0 ? ptVoices : availableVoices;
            utterance.voice = voicesList[userConfig.voiceIndex] || availableVoices[0];
            utterance.rate = 1.2; 
            window.speechSynthesis.cancel(); 
            window.speechSynthesis.speak(utterance);
        }

        // --- CANVAS ---
        window.openCanvas = (code, type) => {
            currentCanvasCode = code; 
            const modal = $('canvas-modal');
            const container = $('canvas-container');
            const consoleDiv = $('canvas-console');
            container.innerHTML = ''; 
            consoleDiv.innerHTML = '<div class="text-gray-500 italic">Console pronto...</div>';
            if (type === 'html') {
                const iframe = document.createElement('iframe');
                iframe.className = "w-full h-full bg-white rounded-lg border-0";
                container.appendChild(iframe);
                const errorCaptureScript = `<script>
                    window.onerror = function(message, source, lineno, colno, error) {
                        window.parent.postMessage({type: 'error', message: message, line: lineno}, '*');
                    };
                    console.log = function(message) {
                        window.parent.postMessage({type: 'log', message: message}, '*');
                    };
                <\/script>`;
                const doc = iframe.contentWindow.document;
                doc.open();
                doc.write(errorCaptureScript + code);
                doc.close();
            } else {
                const pre = document.createElement('pre');
                pre.className = "w-full h-full bg-gray-900 text-green-400 p-4 overflow-auto rounded-lg font-mono text-sm";
                pre.innerText = code;
                container.appendChild(pre);
            }
            modal.classList.remove('hidden');
        };

        window.addEventListener('message', (event) => {
            const consoleDiv = $('canvas-console');
            if(!consoleDiv) return;
            if (event.data.type === 'error') {
                consoleDiv.innerHTML += `<div class="text-red-400 mt-1">‚ùå Erro: ${event.data.message}</div>`;
                $('fix-code-btn').classList.remove('hidden'); 
                $('fix-code-btn').dataset.error = event.data.message;
            } else if (event.data.type === 'log') {
                consoleDiv.innerHTML += `<div class="text-blue-300 mt-1">‚ÑπÔ∏è ${event.data.message}</div>`;
            }
        });

        window.fixCanvasCode = () => {
            const errorMsg = $('fix-code-btn').dataset.error;
            window.closeCanvas();
            const prompt = `O c√≥digo gerado deu erro: "${errorMsg}". Corrija e reenvie:\n\n${currentCanvasCode}`;
            $('input-box').value = prompt;
            window.sendMessage();
        };

        window.closeCanvas = () => {
            $('canvas-modal').classList.add('hidden');
            $('canvas-container').innerHTML = ''; 
            $('fix-code-btn').classList.add('hidden');
        };

        // --- FERRAMENTAS ---
        const Tools = {
            generatePDF: async (title, content) => {
                try {
                    if (!window.jspdf || !window.jspdf.jsPDF) throw new Error("PDF Lib offline.");
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    const pageWidth = doc.internal.pageSize.getWidth();
                    const pageHeight = doc.internal.pageSize.getHeight();
                    const margin = 20;
                    doc.setFontSize(22);
                    doc.setTextColor(40, 40, 40);
                    doc.text(title || "Documento NeuralOS", margin, 20);
                    doc.setLineWidth(0.5);
                    doc.line(margin, 25, pageWidth - margin, 25);
                    doc.setFontSize(12);
                    doc.setTextColor(60, 60, 60);
                    const cleanContent = content.replace(/\*\*/g, "").replace(/#/g, "").replace(/`/g, "");
                    const lines = doc.splitTextToSize(cleanContent, pageWidth - (margin * 2));
                    let cursorY = 35;
                    lines.forEach(line => {
                        if (cursorY + 7 > pageHeight - margin) { doc.addPage(); cursorY = 20; }
                        doc.text(line, margin, cursorY);
                        cursorY += 7;
                    });
                    const fileName = `${(title || 'doc').substring(0, 15).replace(/[^a-z0-9]/gi, '_')}.pdf`;
                    doc.save(fileName);
                    return `PDF "${fileName}" salvo.`;
                } catch (e) { return "Erro PDF: " + e.message; }
            },
            runPython: async (code) => {
                showToast("Python...");
                try {
                    if (!pyodideInstance) pyodideInstance = await loadPyodide();
                    pyodideInstance.setStdout({ batched: (msg) => console.log(msg) });
                    const result = await pyodideInstance.runPythonAsync(code);
                    return result !== undefined ? String(result) : "Executado.";
                } catch (e) { return "Erro Py: " + e.message; }
            },
            scheduleAlert: async (minutes, message) => {
                const ms = parseFloat(minutes) * 60000;
                if (isNaN(ms)) return "Tempo inv√°lido.";
                if (Notification.permission !== 'granted') await Notification.requestPermission();
                setTimeout(() => { new Notification("NeuralOS", { body: message }); speak(`Alerta: ${message}`); }, ms);
                return `Alerta em ${minutes} min.`;
            },
            weather: async (city) => {
                if(!navigator.onLine) return "Offline.";
                try {
                    const geo = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(city)}&count=1&language=pt&format=json`).then(r=>r.json());
                    if(!geo.results) return null;
                    const {latitude, longitude, name} = geo.results[0];
                    const w = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current=temperature_2m,relative_humidity_2m&timezone=auto`).then(r=>r.json());
                    return `${name}: ${w.current.temperature_2m}¬∞C, Umidade ${w.current.relative_humidity_2m}%.`;
                } catch(e) { return null; }
            },
            wiki: async (term) => {
                if(!navigator.onLine) return "Offline.";
                try {
                    const res = await fetch(`https://pt.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(term)}`);
                    if(!res.ok) return null;
                    return (await res.json()).extract;
                } catch(e) { return null; }
            }
        };

        // --- CORE ---
        function updateSystemPrompt() {
            let persona = "Seja conciso.";
            if (userConfig.vibe === 'Jarvis') persona = "Aja como JARVIS. T√©cnico.";
            if (userConfig.vibe === 'Amigo') persona = "Seja casual e amigo.";
            chatHistory[0] = { 
                role: "system", 
                content: `NeuralOS v8.0. USER: ${userConfig.name}. MODE: ${persona}.
TOOLS: [PDF: t|c], [PYTHON: code], [ALERTA: min|txt], [IMG: prompt], [CLIMA: city], [WIKI: term], [MEM: text].
Use MEM apenas se usu√°rio pedir para lembrar algo.` 
            };
        }

        async function initSystem() {
            applyTheme(); 
            const wakeUpPromise = DB.wakeUp();
            updateSystemPrompt(); 

            $('status-text').innerText = "Iniciando...";
            $('loading-bar').style.width = "10%";

            try {
                if (!navigator.gpu) throw new Error("Sem WebGPU.");

                engine = await webllm.CreateMLCEngine(
                    MODEL_ID,
                    { 
                        appConfig: appConfig,
                        initProgressCallback: (report) => {
                            if(report.text.includes("Fetching")) $('status-text').innerText = "Baixando Modelo...";
                            else if(report.text.includes("Loading")) $('status-text').innerText = "Carregando GPU...";
                            $('loading-bar').style.width = "70%";
                        },
                        logLevel: "WARN"
                    }
                );

                await engine.chat.completions.create({ messages: [{ role: "user", content: "hi" }], max_tokens: 1 });
                await wakeUpPromise;
                DB.refreshList();

                $('loading-screen').classList.add('opacity-0', 'pointer-events-none');
                setTimeout(() => $('loading-screen').style.display = 'none', 500);
                lucide.createIcons();
                loadVoices();
                
                if (userConfig.name !== "Usu√°rio") showToast(`Ol√°, ${userConfig.name}`);

            } catch (err) {
                console.error("Erro Fatal:", err);
                $('status-text').innerHTML = `Erro: ${err.message}<br><span class='text-[10px]'>Recarregue ou limpe o cache.</span>`;
                $('status-text').className = "text-red-500 font-bold text-center";
            }
        }

        window.sendMessage = async () => {
            const input = $('input-box');
            let text = input.value.trim();
            if (window.pendingFileContext) {
                text = `${window.pendingFileContext}\n\n${text}`;
                window.pendingFileContext = null;
                $('attach-btn').classList.remove('text-green-500');
                $('file-upload').value = '';
            }
            if (!text || !engine) return;
            const displayUserText = text.length > 500 ? text.slice(text.lastIndexOf('\n')+1) + " (Anexo)" : text;
            appendBubble('user', displayUserText);
            input.value = '';
            let context = "";
            if (text.length > 5 && isOnlineDB) {
                 const memories = await DB.search(text);
                 if (memories.length > 0) {
                     context = `[Contexto da Nuvem: ${memories.join(' | ')}]`;
                     showToast(`üß† Usando ${memories.length} mem√≥rias`);
                 }
            }
            if (context) text = `${context}\n${text}`;
            const tempHistory = [...chatHistory, { role: "user", content: text }];
            const loadingId = showLoading();
            try {
                const reply = await engine.chat.completions.create({
                    messages: tempHistory,
                    temperature: 0.3,
                    max_tokens: 1024,
                });
                let raw = reply.choices[0].message.content;
                let final = raw;
                let toolResult = null;
                const thoughtMatch = raw.match(/<pensamento>(.*?)<\/pensamento>/s);
                if (thoughtMatch) {
                    appendBubble('thought', thoughtMatch[1]);
                    final = raw.replace(/<pensamento>.*?<\/pensamento>/s, "").trim();
                }
                if (final.includes("[PDF:")) {
                    const match = final.match(/\[PDF:\s*(.*?)\s*\|\s*([\s\S]*?)\]/);
                    if (match) {
                        updateLoading(loadingId, "Gerando PDF...");
                        const result = await Tools.generatePDF(match[1], match[2]);
                        removeLoading(loadingId);
                        appendBubble('assistant', `üìÑ ${result}`);
                        chatHistory.push({ role: "user", content: text });
                        chatHistory.push({ role: "assistant", content: raw });
                        if (chatHistory.length > MAX_HISTORY) chatHistory.splice(1, 2);
                        return; 
                    }
                }
                else if (final.includes("[PYTHON:")) {
                    const match = final.match(/\[PYTHON: ([\s\S]*?)\]/);
                    if(match) {
                        updateLoading(loadingId, "Python...");
                        toolResult = await Tools.runPython(match[1]);
                        final = final.replace(/\[PYTHON:.*?\]/s, `üêç Sa√≠da: \`${toolResult}\``);
                    }
                }
                else if (final.includes("[ALERTA:")) {
                    const match = final.match(/\[ALERTA: (.*?)\s*\|\s*(.*?)\]/);
                    if (match) {
                        toolResult = await Tools.scheduleAlert(match[1], match[2]);
                        final = final.replace(/\[ALERTA:.*?\]/s, `‚è∞ ${toolResult}`);
                    }
                }
                else if (final.includes("[IMG:")) {
                    const match = final.match(/\[IMG: (.*?)\]/);
                    if(match) {
                        const imgUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(match[1])}`;
                        final = final.replace(/\[IMG:.*?\]/, `üé® Imagem:<br><img src="${imgUrl}" class="mt-2 rounded-lg w-full h-auto shadow-md" alt="${match[1]}">`);
                    }
                }
                else if (final.includes("[CLIMA:")) {
                    const match = final.match(/\[CLIMA: (.*?)\]/);
                    if(match) {
                        toolResult = await Tools.weather(match[1]);
                        if(toolResult) final += `\n(${toolResult})`;
                    }
                }
                else if (final.includes("[WIKI:")) {
                    const match = final.match(/\[WIKI: (.*?)\]/);
                    if(match) {
                        updateLoading(loadingId, "Wiki...");
                        toolResult = await Tools.wiki(match[1]);
                        if(toolResult) final += `\nüìñ Wiki: ${toolResult}`;
                    }
                }
                else if (final.includes("[MEM:")) {
                    const match = final.match(/\[MEM: (.*?)\]/);
                    if(match) {
                        await DB.add(match[1]);
                        final = final.replace(/\[MEM:.*?\]/, "üíæ Mem√≥ria salva na nuvem.");
                    }
                }
                removeLoading(loadingId);
                appendBubble('assistant', final);
                speak(final);
                chatHistory.push({ role: "user", content: text });
                chatHistory.push({ role: "assistant", content: final });
                if (chatHistory.length > MAX_HISTORY) chatHistory.splice(1, 2);
            } catch (e) {
                removeLoading(loadingId);
                appendBubble('system', "Erro: " + e.message);
            }
        };

        function appendBubble(role, text) {
            const box = $('chat-content');
            const div = document.createElement('div');
            const dark = userConfig.amoled;
            if (role === 'thought') {
                div.className = "flex w-full mb-2 animate-fade-in";
                div.innerHTML = `<div class="${dark ? 'bg-gray-900 text-gray-500 border-gray-700' : 'bg-gray-100 text-gray-500 border-gray-400'} text-xs italic p-2 rounded-lg border-l-2 max-w-[85%]">üí≠ ${text}</div>`;
            } else if (role === 'system') {
                div.className = "flex w-full justify-center mb-2 animate-fade-in";
                div.innerHTML = `<div class="bg-yellow-500/20 text-yellow-600 text-xs px-3 py-1 rounded-full">${text}</div>`;
            } else {
                const isUser = role === 'user';
                div.className = `flex w-full mb-4 animate-fade-in ${isUser ? 'justify-end' : 'justify-start'}`;
                let contentHTML = marked.parse(text);
                if (!isUser && (text.includes("```html") || text.includes("```js"))) {
                    const codeMatch = text.match(/```(html|js)([\s\S]*?)```/);
                    if (codeMatch) {
                        const codeContent = codeMatch[2].replace(/`/g, '\\`').replace(/"/g, '&quot;');
                        contentHTML += `<button onclick="openCanvas(\`${codeContent}\`, '${codeMatch[1]}')" class="mt-2 flex items-center gap-2 bg-green-600 text-white px-4 py-2 rounded-lg text-xs font-bold w-full justify-center">Testar no Canvas</button>`;
                    }
                }
                div.innerHTML = `<div class="max-w-[90%] p-3.5 rounded-2xl shadow-sm text-sm leading-relaxed overflow-hidden ${isUser ? 'bg-indigo-600 text-white rounded-tr-sm' : (dark ? 'bg-gray-800 text-gray-200 border-gray-700' : 'bg-white text-gray-800 border-gray-200') + ' border rounded-tl-sm prose prose-sm prose-invert'}">${contentHTML}</div>`;
            }
            box.appendChild(div);
            lucide.createIcons();
            requestAnimationFrame(() => box.scrollTop = box.scrollHeight);
        }

        function showLoading() {
            const id = 'load-' + Date.now();
            const box = $('chat-content');
            const dark = userConfig.amoled;
            const div = document.createElement('div');
            div.id = id;
            div.className = "flex w-full mb-4 animate-fade-in";
            div.innerHTML = `<div class="${dark ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-200'} border px-3 py-2 rounded-2xl text-xs text-gray-400 flex items-center gap-2"><span class="animate-spin">‚öôÔ∏è</span> <span id="${id}-txt">Processando...</span></div>`;
            box.appendChild(div);
            requestAnimationFrame(() => box.scrollTop = box.scrollHeight);
            return id;
        }
        function updateLoading(id, txt) { const el = $(id+'-txt'); if(el) el.innerText = txt; }
        function removeLoading(id) { const el = $(id); if(el) el.remove(); }
        function showToast(msg) { 
            const t = document.createElement('div');
            t.className = "fixed top-20 left-1/2 -translate-x-1/2 bg-gray-900 text-white text-xs px-4 py-2 rounded-full shadow-lg z-50 animate-fade-in";
            t.innerText = msg;
            document.body.appendChild(t);
            setTimeout(() => t.remove(), 2000);
        }

        window.toggleSettings = () => { $('settings-modal').classList.toggle('hidden'); loadVoices(); $('input-name').value = userConfig.name; $('select-vibe').value = userConfig.vibe; $('check-tts').checked = userConfig.ttsEnabled; $('check-amoled').checked = userConfig.amoled; };
        window.saveSettings = () => { 
            userConfig.name = $('input-name').value;
            userConfig.vibe = $('select-vibe').value;
            userConfig.ttsEnabled = $('check-tts').checked;
            userConfig.voiceIndex = $('select-voice').selectedIndex;
            userConfig.amoled = $('check-amoled').checked;
            try {
                localStorage.setItem('neural_user_name', userConfig.name);
                localStorage.setItem('neural_ai_vibe', userConfig.vibe);
                localStorage.setItem('neural_tts', userConfig.ttsEnabled);
                localStorage.setItem('neural_voice_idx', userConfig.voiceIndex);
                localStorage.setItem('neural_amoled', userConfig.amoled);
                showToast("Prefer√™ncias Salvas");
            } catch(e) { showToast("Erro Storage"); }
            applyTheme(); updateSystemPrompt(); $('settings-modal').classList.add('hidden');
        };
        window.switchTab = (tab) => {
            if (tab === 'chat') {
                $('view-chat').classList.remove('hidden'); $('view-mem').classList.add('hidden');
                $('btn-chat').classList.add('bg-indigo-100', 'text-indigo-700'); $('btn-mem').classList.remove('bg-indigo-100', 'text-indigo-700');
            } else {
                $('view-chat').classList.add('hidden'); $('view-mem').classList.remove('hidden');
                $('btn-mem').classList.add('bg-indigo-100', 'text-indigo-700'); $('btn-chat').classList.remove('bg-indigo-100', 'text-indigo-700');
                DB.refreshList();
            }
        };
        window.triggerFileUpload = () => $('file-upload').click();
        $('input-box').addEventListener('keypress', (e) => { if (e.key === 'Enter') window.sendMessage(); });
        window.onload = initSystem;
    </script>
    <style>
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        ::-webkit-scrollbar { width: 0px; } 
    </style>
</head>
<body class="font-sans antialiased bg-slate-50 text-slate-800 transition-colors duration-300 h-full w-full overflow-hidden flex flex-col">

    <!-- CANVAS MODAL -->
    <div id="canvas-modal" class="hidden fixed inset-0 z-50 bg-black flex flex-col animate-fade-in">
        <div class="h-12 bg-gray-900 flex items-center justify-between px-4 border-b border-gray-800 shrink-0">
            <h3 class="text-white text-sm font-bold flex items-center gap-2"><i data-lucide="layout" class="w-4 h-4 text-green-400"></i> Canvas</h3>
            <div class="flex gap-2">
                <button id="fix-code-btn" onclick="fixCanvasCode()" class="hidden bg-red-600 text-white px-3 py-1 rounded text-xs font-bold flex items-center gap-1"><i data-lucide="wrench" class="w-3 h-3"></i> Corrigir</button>
                <button onclick="closeCanvas()" class="text-gray-400 hover:text-white p-2"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
        </div>
        <div id="canvas-container" class="flex-1 w-full bg-white relative"></div>
        <div class="h-32 bg-gray-950 border-t border-gray-800 p-2 overflow-y-auto font-mono text-[10px] shrink-0" id="canvas-console"><div class="text-gray-600 italic">Console...</div></div>
    </div>

    <!-- SETTINGS MODAL -->
    <div id="settings-modal" class="hidden absolute inset-0 z-40 bg-black/50 flex items-center justify-center p-4 backdrop-blur-sm modal-bg">
        <div class="bg-white w-full max-w-xs rounded-2xl p-6 shadow-2xl modal-bg">
            <h2 class="text-lg font-bold mb-4">Ajustes</h2>
            <label class="block text-xs font-bold text-gray-500 mb-1">Nome</label>
            <input id="input-name" type="text" class="w-full bg-gray-100 rounded p-2 text-sm mb-3 text-black">
            <label class="block text-xs font-bold text-gray-500 mb-1">Persona</label>
            <select id="select-vibe" class="w-full bg-gray-100 rounded p-2 text-sm mb-3 text-black">
                <option value="Assistente Padr√£o">Padr√£o</option>
                <option value="Jarvis">Jarvis</option>
                <option value="Amigo">Amigo</option>
            </select>
            <label class="block text-xs font-bold text-gray-500 mb-1">Voz</label>
            <select id="select-voice" class="w-full bg-gray-100 rounded p-2 text-sm mb-3 text-xs text-black"><option>Carregando...</option></select>
            <div class="flex items-center justify-between mb-4"><span class="text-sm">Fala Ativa</span><input id="check-tts" type="checkbox" class="w-5 h-5 accent-indigo-600"></div>
            <div class="flex items-center justify-between mb-6"><span class="text-sm">Modo AMOLED</span><input id="check-amoled" type="checkbox" class="w-5 h-5 accent-black"></div>
            <button onclick="saveSettings()" class="w-full bg-indigo-600 text-white py-2 rounded-xl font-bold">Salvar</button>
            <button onclick="toggleSettings()" class="w-full mt-2 text-gray-400 text-xs">Fechar</button>
        </div>
    </div>

    <!-- LOADING SCREEN -->
    <div id="loading-screen" class="absolute inset-0 z-50 bg-white flex flex-col items-center justify-center p-8 transition-opacity duration-500">
        <div class="w-20 h-20 mb-6 rounded-3xl bg-indigo-600 flex items-center justify-center shadow-xl animate-bounce"><i data-lucide="cloud" class="text-white w-10 h-10"></i></div>
        <h2 class="text-2xl font-bold text-gray-800 mb-1">NeuralOS <span class="text-indigo-600">Cloud</span></h2>
        <p id="status-text" class="text-gray-400 text-xs font-mono mb-8">Conectando...</p>
        <div class="w-48 h-1.5 bg-gray-100 rounded-full overflow-hidden"><div id="loading-bar" class="h-full bg-indigo-600 transition-all duration-300 w-0"></div></div>
    </div>

    <!-- MAIN APP STRUCTURE -->
    <div id="main-app-container" class="flex-1 flex flex-col relative overflow-hidden max-w-md mx-auto w-full h-full border-x border-gray-100 shadow-2xl bg-white">
        <header class="h-14 backdrop-blur border-b border-gray-100 flex items-center justify-between px-4 shrink-0 z-20 transition-colors" id="main-header">
            <div class="flex items-center gap-3">
                <button onclick="toggleSettings()" class="p-2 rounded-full hover:bg-gray-200/50"><i data-lucide="settings" class="w-5 h-5 text-gray-500"></i></button>
                <div>
                    <h1 class="font-bold text-sm">NeuralOS</h1>
                    <div id="status-indicator" onclick="DB.retryConnection()" class="text-[10px] text-gray-400 font-medium cursor-pointer">‚óè Conectando...</div>
                </div>
            </div>
            <div class="flex bg-gray-100/50 p-1 rounded-full">
                <button id="btn-chat" onclick="switchTab('chat')" class="px-4 py-1.5 rounded-full text-xs font-bold bg-indigo-100 text-indigo-700 transition-all">Chat</button>
                <button id="btn-mem" onclick="switchTab('mem')" class="px-4 py-1.5 rounded-full text-xs font-bold text-gray-500 hover:text-indigo-600 transition-all">Nuvem</button>
            </div>
        </header>

        <!-- CHAT -->
        <div id="view-chat" class="flex-1 flex flex-col relative overflow-hidden h-full">
            <div id="chat-box" class="flex-1 overflow-y-auto scroll-smooth p-4">
                <div id="chat-content" class="pt-2 space-y-4">
                    <div class="flex justify-center"><span class="text-[10px] opacity-50 px-3 py-1 rounded-full border flex items-center gap-1"><i data-lucide="server" class="w-3 h-3 text-blue-500"></i> Cloud Memory Enabled</span></div>
                </div>
            </div>
            <div id="input-container" class="w-full p-4 bg-white z-10 transition-colors shrink-0 border-t border-gray-100">
                <div id="input-wrapper" class="flex items-center gap-2 border p-1.5 pl-2 rounded-full shadow-sm bg-white">
                    <button id="attach-btn" onclick="triggerFileUpload()" class="w-9 h-9 rounded-full text-gray-400 hover:text-indigo-600 flex items-center justify-center transition-colors"><i data-lucide="paperclip" class="w-5 h-5"></i></button>
                    <input type="file" id="file-upload" multiple class="hidden" onchange="handleFiles()">
                    <input id="input-box" type="text" class="flex-1 bg-transparent text-sm focus:outline-none placeholder-gray-400 text-gray-800" placeholder="Digite...">
                    <button id="mic-btn" onclick="window.toggleMic && window.toggleMic()" class="w-9 h-9 rounded-full bg-gray-100 text-gray-500 hover:bg-red-100 hover:text-red-500 flex items-center justify-center transition-colors"><i data-lucide="mic" class="w-5 h-5"></i></button>
                    <button onclick="window.sendMessage()" class="w-10 h-10 bg-indigo-600 hover:bg-indigo-500 rounded-full flex items-center justify-center text-white shadow-lg transition-transform active:scale-95"><i data-lucide="arrow-up" class="w-5 h-5"></i></button>
                </div>
            </div>
        </div>

        <!-- MEMORY -->
        <div id="view-mem" class="hidden flex-1 flex flex-col overflow-hidden h-full">
            <div class="p-4 border-b flex justify-between items-center shrink-0">
                <h3 class="font-bold text-xs uppercase tracking-wider opacity-70">Mem√≥ria Nuvem (<span id="mem-count">0</span>)</h3>
                <div class="flex gap-2"><button onclick="DB.refreshList()" class="p-2 rounded-full hover:bg-gray-100"><i data-lucide="refresh-cw" class="w-4 h-4"></i></button></div>
            </div>
            <div id="memory-list" class="flex-1 overflow-y-auto p-4"></div>
        </div>
    </div>
</body>
</html>
