<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, interactive-widget=resizes-content">
    <title>NeuralOS Modular</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/12.0.0/marked.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- 
        NOTA PARA O DESENVOLVEDOR (VOC√ä):
        Este c√≥digo foi estruturado em M√ìDULOS.
        Para levar ao GitHub, voc√™ pode separar as classes abaixo em arquivos:
        - MemorySystem -> memory.js
        - NetworkAgent -> network.js
        - NeuralCore   -> core.js
        - UIController -> ui.js
    -->

    <script type="module">
        import * as webllm from "https://esm.run/@mlc-ai/web-llm";

        // ==========================================
        // M√ìDULO 1: SISTEMA DE MEM√ìRIA (Excel.js)
        // ==========================================
        class MemorySystem {
            constructor() {
                this.db = [];
                this.load();
            }

            load() {
                const saved = localStorage.getItem('neural_db_v2');
                this.db = saved ? JSON.parse(saved) : [];
            }

            save() {
                localStorage.setItem('neural_db_v2', JSON.stringify(this.db));
                window.ui.renderTable(); // Atualiza UI sempre que salvar
            }

            add(content, category = "Geral") {
                const id = Date.now();
                const date = new Date().toLocaleDateString('pt-BR');
                this.db.unshift({ id, date, category, content });
                this.save();
                return id;
            }

            delete(id) {
                this.db = this.db.filter(item => item.id !== id);
                this.save();
            }

            edit(id, field, newValue) {
                const row = this.db.find(item => item.id === id);
                if (row) {
                    row[field] = newValue;
                    this.save();
                }
            }

            search(query) {
                if (!query) return this.db.slice(0, 5);
                const term = query.toLowerCase();
                return this.db.filter(row => 
                    row.content.toLowerCase().includes(term) || 
                    row.category.toLowerCase().includes(term)
                ).slice(0, 5);
            }
        }

        // ==========================================
        // M√ìDULO 2: AGENTE DE INTERNET (Network.js)
        // ==========================================
        class NetworkAgent {
            execute(command) {
                // YOUTUBE
                if (command.includes("[YOUTUBE:")) {
                    const term = command.match(/\[YOUTUBE: (.*?)\]/)[1];
                    this.openUrl(`https://www.youtube.com/results?search_query=${encodeURIComponent(term)}`);
                    return { type: 'video', text: `Abrindo YouTube para: ${term}`, icon: 'play-circle' };
                }
                
                // GOOGLE
                if (command.includes("[GOOGLE:")) {
                    const term = command.match(/\[GOOGLE: (.*?)\]/)[1];
                    this.openUrl(`https://www.google.com/search?q=${encodeURIComponent(term)}`);
                    return { type: 'search', text: `Pesquisando: ${term}`, icon: 'search' };
                }

                // SPOTIFY
                if (command.includes("[SPOTIFY:")) {
                    const term = command.match(/\[SPOTIFY: (.*?)\]/)[1];
                    this.openUrl(`https://open.spotify.com/search/${encodeURIComponent(term)}`);
                    return { type: 'music', text: `Abrindo Spotify: ${term}`, icon: 'music' };
                }

                return null;
            }

            openUrl(url) {
                // Em um app real (Capacitor), usariamos AppLauncher.openUrl
                window.open(url, '_blank');
            }
        }

        // ==========================================
        // M√ìDULO 3: N√öCLEO DA IA (Core.js)
        // ==========================================
        class NeuralCore {
            constructor(memorySystem, networkAgent) {
                this.engine = null;
                this.memory = memorySystem;
                this.network = networkAgent;
                this.model = "Llama-3.2-3B-Instruct-q4f16_1-MLC";
                this.history = [];
            }

            async init(progressCallback) {
                if (!navigator.gpu) throw new Error("Sem GPU detectada.");
                
                this.engine = await webllm.CreateMLCEngine(
                    this.model,
                    { 
                        initProgressCallback: progressCallback,
                        logLevel: "WARN",
                        appConfig: { use_indexed_db_cache: true } // Cache Persistente
                    }
                );

                // Warm-up
                await this.engine.chat.completions.create({ messages: [{role:"user", content:"hi"}], max_tokens: 1 });
                
                // Prompt do Sistema Inteligente
                this.history = [{ 
                    role: "system", 
                    content: `
Voc√™ √© o NeuralOS.
Aja como um Sistema Operacional Inteligente.

COMANDOS DE SISTEMA (Use Obrigat√≥riamente):
- Para v√≠deos/m√∫sica: [YOUTUBE: busca] ou [SPOTIFY: busca]
- Para internet: [GOOGLE: busca]
- Para salvar mem√≥ria: [MEMORIA_SALVAR: texto]
- Para ler mem√≥ria: [MEMORIA_LER: termo]

Estilo: Curto, direto e eficiente.
` 
                }];
            }

            async process(text) {
                // 1. Adiciona usu√°rio ao hist√≥rico
                this.history.push({ role: "user", content: text });
                if (this.history.length > 10) this.history.splice(1, 1);

                // 2. Gera resposta
                const reply = await this.engine.chat.completions.create({
                    messages: this.history,
                    temperature: 0.7,
                    max_tokens: 1024,
                    stream: false // Instant√¢neo
                });

                let responseText = reply.choices[0].message.content;
                let actionResult = null;

                // 3. Verifica A√ß√µes de Rede
                const netAction = this.network.execute(responseText);
                if (netAction) {
                    responseText = netAction.text;
                    actionResult = netAction;
                }

                // 4. Verifica A√ß√µes de Mem√≥ria (Salvar)
                if (responseText.includes("[MEMORIA_SALVAR:")) {
                    const content = responseText.match(/\[MEMORIA_SALVAR: (.*?)\]/)[1];
                    const id = this.memory.add(content);
                    responseText = `üíæ Salvo no Banco de Dados (ID #${id.toString().slice(-4)})`;
                }

                // 5. Verifica A√ß√µes de Mem√≥ria (Ler/RAG)
                if (responseText.includes("[MEMORIA_LER:")) {
                    const term = responseText.match(/\[MEMORIA_LER: (.*?)\]/)[1];
                    const results = this.memory.search(term);
                    const context = JSON.stringify(results);
                    
                    // Injeta mem√≥ria e pede nova resposta
                    this.history.push({ role: "system", content: `DADOS ENCONTRADOS NO EXCEL: ${context}. Responda o usu√°rio com base nisso.` });
                    const ragReply = await this.engine.chat.completions.create({ messages: this.history });
                    responseText = ragReply.choices[0].message.content;
                }

                // 6. Atualiza hist√≥rico da IA
                this.history.push({ role: "assistant", content: responseText });

                return { text: responseText, action: actionResult };
            }
        }

        // ==========================================
        // M√ìDULO 4: CONTROLADOR UI (Main.js)
        // ==========================================
        class UIController {
            constructor() {
                this.memory = new MemorySystem();
                this.network = new NetworkAgent();
                this.core = new NeuralCore(this.memory, this.network);
                
                // Expor para window para o HTML acessar (onclicks)
                window.ui = this; 
                
                this.setupEventListeners();
                this.init();
            }

            async init() {
                try {
                    await this.core.init((report) => {
                        const pct = report.text.match(/(\d+)%/) ? report.text.match(/(\d+)%/)[1] + "%" : "";
                        $('loading-status').innerText = report.text.includes("Fetching") ? `Baixando IA (${pct})...` : `Carregando (${pct})...`;
                        $('loading-bar').style.width = pct || "50%";
                    });
                    
                    // Esconde Loading
                    $('loading-screen').classList.add('hidden');
                    this.renderTable();
                } catch (e) {
                    $('loading-status').innerText = "Erro: " + e.message;
                    $('loading-status').classList.add('text-red-500');
                }
            }

            setupEventListeners() {
                $('send-btn').onclick = () => this.sendMessage();
                $('input-box').onkeypress = (e) => { if(e.key === 'Enter') this.sendMessage() };
                
                // Tabs
                $('btn-chat').onclick = () => this.switchTab('chat');
                $('btn-db').onclick = () => this.switchTab('db');
            }

            async sendMessage() {
                const input = $('input-box');
                const text = input.value.trim();
                if (!text) return;

                // UI Usu√°rio
                this.appendBubble('user', text);
                input.value = '';

                // UI Loading
                const loadingId = this.showLoading();

                // Processamento
                const result = await this.core.process(text);

                // UI Resposta
                this.removeLoading(loadingId);
                this.appendBubble('assistant', result.text);
            }

            appendBubble(role, text) {
                const box = $('chat-box');
                const div = document.createElement('div');
                const isUser = role === 'user';
                
                div.className = `flex w-full mb-4 animate-fade-in ${isUser ? 'justify-end' : 'justify-start'}`;
                
                const contentHtml = isUser ? text : marked.parse(text);
                
                div.innerHTML = `
                    <div class="max-w-[85%] p-4 rounded-2xl shadow-sm text-[15px] leading-relaxed ${
                        isUser 
                        ? 'bg-blue-600 text-white rounded-tr-sm' 
                        : 'bg-gray-800 border border-gray-700 text-gray-200 rounded-tl-sm prose prose-invert'
                    }">
                        ${contentHtml}
                    </div>
                `;
                box.appendChild(div);
                box.scrollTo({ top: box.scrollHeight, behavior: 'smooth' });
            }

            showLoading() {
                const id = 'load-' + Date.now();
                const box = $('chat-box');
                const div = document.createElement('div');
                div.id = id;
                div.className = 'flex w-full mb-4 justify-start animate-fade-in';
                div.innerHTML = `
                    <div class="bg-gray-800 border border-gray-700 px-4 py-3 rounded-2xl rounded-tl-sm flex items-center gap-2">
                        <div class="flex gap-1">
                            <div class="w-2 h-2 bg-blue-500 rounded-full animate-bounce"></div>
                            <div class="w-2 h-2 bg-blue-500 rounded-full animate-bounce delay-75"></div>
                            <div class="w-2 h-2 bg-blue-500 rounded-full animate-bounce delay-150"></div>
                        </div>
                    </div>`;
                box.appendChild(div);
                box.scrollTo({ top: box.scrollHeight, behavior: 'smooth' });
                return id;
            }

            removeLoading(id) {
                const el = document.getElementById(id);
                if (el) el.remove();
            }

            switchTab(tab) {
                if (tab === 'chat') {
                    $('view-chat').classList.remove('hidden');
                    $('view-db').classList.add('hidden');
                    $('btn-chat').classList.add('bg-blue-600', 'text-white');
                    $('btn-chat').classList.remove('bg-gray-800', 'text-gray-400');
                    $('btn-db').classList.remove('bg-blue-600', 'text-white');
                    $('btn-db').classList.add('bg-gray-800', 'text-gray-400');
                } else {
                    $('view-chat').classList.add('hidden');
                    $('view-db').classList.remove('hidden');
                    $('btn-db').classList.add('bg-blue-600', 'text-white');
                    $('btn-db').classList.remove('bg-gray-800', 'text-gray-400');
                    $('btn-chat').classList.remove('bg-blue-600', 'text-white');
                    $('btn-chat').classList.add('bg-gray-800', 'text-gray-400');
                    this.renderTable();
                }
            }

            // --- L√≥gica da Planilha Excel ---
            renderTable() {
                const tbody = $('table-body');
                tbody.innerHTML = '';
                const data = this.memory.db;

                if (data.length === 0) {
                    $('empty-state').classList.remove('hidden');
                    return;
                }
                $('empty-state').classList.add('hidden');

                data.forEach(row => {
                    const tr = document.createElement('tr');
                    tr.className = "border-b border-gray-700 hover:bg-gray-750 group";
                    tr.innerHTML = `
                        <td class="p-3 text-gray-500 font-mono text-xs">${row.id.toString().slice(-4)}</td>
                        <td class="p-3 text-blue-400 text-xs">${row.date}</td>
                        <td class="p-3 text-gray-200">
                            <input onchange="ui.updateCell(${row.id}, 'content', this.value)" 
                                   value="${row.content}" 
                                   class="bg-transparent w-full focus:outline-none focus:border-b border-blue-500">
                        </td>
                        <td class="p-3 text-gray-400">
                            <input onchange="ui.updateCell(${row.id}, 'category', this.value)" 
                                   value="${row.category}" 
                                   class="bg-transparent w-full text-xs focus:outline-none focus:border-b border-blue-500">
                        </td>
                        <td class="p-3 text-right">
                            <button onclick="ui.deleteItem(${row.id})" class="text-red-500 opacity-0 group-hover:opacity-100 transition-opacity p-1 hover:bg-red-500/10 rounded">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
                lucide.createIcons();
                $('record-count').innerText = `${data.length} registros`;
            }

            updateCell(id, field, value) {
                this.memory.edit(id, field, value);
            }

            deleteItem(id) {
                if(confirm("Apagar linha?")) {
                    this.memory.delete(id);
                    this.renderTable();
                }
            }
        }

        // Helper
        const $ = (id) => document.getElementById(id);

        // Start
        window.onload = () => new UIController();

    </script>
    <style>
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        body { background: #0f172a; color: white; height: 100dvh; display: flex; flex-direction: column; overflow: hidden; }
        .delay-75 { animation-delay: 75ms; }
        .delay-150 { animation-delay: 150ms; }
    </style>
</head>
<body class="font-sans antialiased">

    <!-- LOADING SCREEN -->
    <div id="loading-screen" class="absolute inset-0 z-50 bg-[#0f172a] flex flex-col items-center justify-center p-8">
        <div class="relative w-20 h-20 mb-6">
            <div class="absolute inset-0 border-t-4 border-blue-500 rounded-full animate-spin"></div>
            <div class="absolute inset-2 border-r-4 border-purple-500 rounded-full animate-spin"></div>
            <div class="absolute inset-0 flex items-center justify-center">
                <i data-lucide="cpu" class="w-8 h-8 text-white"></i>
            </div>
        </div>
        <h2 class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-purple-400">NeuralOS v2.0</h2>
        <p id="loading-status" class="text-gray-400 text-xs font-mono mb-6 mt-2">Carregando M√≥dulos...</p>
        <div class="w-48 h-1 bg-gray-800 rounded-full overflow-hidden">
            <div id="loading-bar" class="h-full bg-blue-500 transition-all duration-300 w-0"></div>
        </div>
    </div>

    <!-- MAIN APP STRUCTURE -->
    <div class="flex-1 flex flex-col relative overflow-hidden">
        
        <!-- HEADER -->
        <header class="h-16 bg-[#1e293b]/80 backdrop-blur border-b border-gray-700 flex items-center justify-between px-4 shrink-0 z-20">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-blue-600 to-indigo-600 flex items-center justify-center shadow-lg">
                    <i data-lucide="brain-circuit" class="text-white w-6 h-6"></i>
                </div>
                <div>
                    <h1 class="font-bold text-sm tracking-wide">Neural<span class="text-blue-400">OS</span></h1>
                    <span class="text-[10px] text-gray-400 bg-gray-800 px-1.5 py-0.5 rounded border border-gray-700">MODULAR</span>
                </div>
            </div>
            
            <div class="flex bg-gray-800 p-1 rounded-lg gap-1">
                <button id="btn-chat" class="px-3 py-1.5 rounded-md text-xs font-bold bg-blue-600 text-white flex items-center gap-2 transition-all">
                    <i data-lucide="message-square" class="w-3 h-3"></i> Chat
                </button>
                <button id="btn-db" class="px-3 py-1.5 rounded-md text-xs font-bold bg-gray-800 text-gray-400 hover:text-white flex items-center gap-2 transition-all">
                    <i data-lucide="sheet" class="w-3 h-3"></i> Excel
                </button>
            </div>
        </header>

        <!-- VIEW: CHAT -->
        <div id="view-chat" class="flex-1 flex flex-col relative overflow-hidden">
            <div id="chat-box" class="flex-1 overflow-y-auto p-4 pb-24 scroll-smooth">
                <!-- Welcome -->
                <div class="flex justify-center mt-6">
                    <span class="text-[10px] text-gray-500 bg-gray-800/50 px-3 py-1 rounded-full border border-gray-700">
                        Sistema Pronto ‚Ä¢ Mem√≥ria Conectada ‚Ä¢ Web Ativa
                    </span>
                </div>
            </div>

            <!-- Input Flutuante -->
            <div class="absolute bottom-0 w-full p-4 bg-gradient-to-t from-[#0f172a] via-[#0f172a] to-transparent z-10">
                <div class="flex items-center gap-2 bg-[#1e293b] border border-gray-700 p-2 rounded-full shadow-2xl">
                    <input id="input-box" type="text" class="flex-1 bg-transparent px-4 py-2 text-sm text-white focus:outline-none placeholder-gray-500" placeholder="Digite: Tocar Rock, Salvar nota...">
                    <button id="send-btn" class="w-10 h-10 bg-blue-600 hover:bg-blue-500 rounded-full flex items-center justify-center text-white shadow-lg transition-transform active:scale-95">
                        <i data-lucide="send" class="w-4 h-4 ml-0.5"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- VIEW: DATABASE (Excel) -->
        <div id="view-db" class="hidden flex-1 flex flex-col bg-[#0f172a] overflow-hidden">
            <div class="p-3 bg-[#1e293b] border-b border-gray-700 flex justify-between items-center">
                <h2 class="text-xs font-bold text-gray-300 flex items-center gap-2">
                    <i data-lucide="database" class="w-3 h-3 text-blue-400"></i> BANCO DE DADOS
                </h2>
                <span id="record-count" class="text-[10px] text-gray-500 font-mono">0 registros</span>
            </div>

            <div class="flex-1 overflow-auto">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-gray-800 text-[10px] uppercase text-gray-400 sticky top-0 z-10 shadow-sm">
                        <tr>
                            <th class="p-3 w-16 border-b border-gray-700">ID</th>
                            <th class="p-3 w-24 border-b border-gray-700">Data</th>
                            <th class="p-3 border-b border-gray-700">Conte√∫do (Edit√°vel)</th>
                            <th class="p-3 w-32 border-b border-gray-700">Categoria</th>
                            <th class="p-3 w-10 border-b border-gray-700"></th>
                        </tr>
                    </thead>
                    <tbody id="table-body" class="text-sm divide-y divide-gray-800">
                        <!-- Rows -->
                    </tbody>
                </table>

                <div id="empty-state" class="hidden flex flex-col items-center justify-center mt-20 opacity-50">
                    <i data-lucide="table" class="w-12 h-12 text-gray-600 mb-2"></i>
                    <p class="text-sm text-gray-400">Tabela vazia.</p>
                </div>
            </div>
        </div>

    </div>

</body>
</html>
