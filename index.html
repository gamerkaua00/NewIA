<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, interactive-widget=resizes-content">
    <title>NeuralOS - Sistema Unificado</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/12.0.0/marked.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script type="module">
        // Importando versÃ£o especÃ­fica para estabilidade
        import * as webllm from "https://cdn.jsdelivr.net/npm/@mlc-ai/web-llm@0.2.72/+esm";

        // --- CONFIGURAÃ‡ÃƒO BLINDADA (Corrige o erro 'find') ---
        // Definimos explicitamente onde estÃ£o os arquivos para a biblioteca nÃ£o se perder.
        const modelConfig = {
            model_list: [
                {
                    "model_id": "Llama-3.2-3B-Instruct-q4f16_1-MLC",
                    "model_lib_url": "https://raw.githubusercontent.com/mlc-ai/binary-mlc-llm-libs/main/webllm-dyn/Llama-3.2-3B-Instruct-q4f16_1-MLC-webgpu.wasm",
                    "model_url": "https://huggingface.co/mlc-ai/Llama-3.2-3B-Instruct-q4f16_1-MLC/resolve/main/",
                    "vram_required_MB": 2800,
                    "low_resource_required": false,
                }
            ],
            use_indexed_db_cache: true
        };
        
        const MODEL_ID = "Llama-3.2-3B-Instruct-q4f16_1-MLC";
        const MAX_HISTORY = 10;

        // VariÃ¡veis Globais (Sistema Unificado)
        let engine = null;
        let chatHistory = [];
        let memoryDB = [];
        
        // Helper
        const $ = (id) => document.getElementById(id);

        // --- SISTEMA DE INICIALIZAÃ‡ÃƒO ---
        async function initSystem() {
            // 1. Carregar MemÃ³ria
            loadMemoryDB();
            renderDatabaseTable();

            $('status-text').innerText = "Verificando arquivos do modelo...";
            $('loading-bar').style.width = "10%";

            const initProgressCallback = (report) => {
                const text = report.text;
                // LÃ³gica de feedback visual
                if(text.includes("Fetching")) {
                    const match = text.match(/(\d+)%/);
                    const pct = match ? match[1] : "0";
                    $('status-text').innerText = `Baixando MÃ³dulos (${pct}%)...`;
                    $('loading-bar').style.width = pct + "%";
                } else if (text.includes("Loading")) {
                     $('status-text').innerText = "Carregando na RAM...";
                     $('loading-bar').style.width = "90%";
                } else if (text.includes("Finish")) {
                     $('loading-bar').style.width = "100%";
                }
            };

            try {
                if (!navigator.gpu) throw new Error("Seu navegador nÃ£o tem acesso Ã  GPU (WebGPU).");

                // Inicializa Motor
                engine = await webllm.CreateMLCEngine(
                    MODEL_ID,
                    { 
                        appConfig: modelConfig, // Aqui estÃ¡ a correÃ§Ã£o do erro
                        initProgressCallback: initProgressCallback,
                        logLevel: "WARN"
                    }
                );

                // Aquecimento (Warmup)
                await engine.chat.completions.create({ messages: [{ role: "user", content: "hi" }], max_tokens: 1 });

                // UI Ready
                $('loading-screen').classList.add('opacity-0', 'pointer-events-none');
                setTimeout(() => $('loading-screen').style.display = 'none', 500);
                
                // Prompt do Sistema (CÃ©rebro do OS)
                chatHistory = [{ 
                    role: "system", 
                    content: `
VocÃª Ã© o NeuralOS. Um sistema operacional inteligente e prestativo.
REGRAS:
1. Responda sempre em PortuguÃªs do Brasil.
2. Use formataÃ§Ã£o Markdown (negrito, listas) para clareza.
3. Se o usuÃ¡rio pedir mÃºsica/vÃ­deo, use [YOUTUBE: busca].
4. Se o usuÃ¡rio pedir pesquisa, use [GOOGLE: busca].
5. Se o usuÃ¡rio contar algo pessoal, use [SALVAR_MEMORIA: texto].
6. Se precisar lembrar de algo, use [LER_MEMORIA: termo].
` 
                }];

            } catch (err) {
                $('status-text').innerText = "Erro: " + err.message;
                $('status-text').className = "text-red-400 text-xs font-mono mb-6 mt-2";
                $('loading-bar').className = "h-full bg-red-600 transition-all duration-300 w-full";
                console.error(err);
                
                // BotÃ£o de Reset de EmergÃªncia
                const btn = document.createElement('button');
                btn.innerText = "Limpar Cache e Tentar Novamente";
                btn.className = "mt-4 bg-red-600 px-4 py-2 rounded text-white text-sm";
                btn.onclick = () => { localStorage.clear(); location.reload(); };
                $('loading-screen').appendChild(btn);
            }
        }

        // --- SISTEMA DE MEMÃ“RIA (Excel Simplificado) ---
        function loadMemoryDB() {
            try {
                const saved = localStorage.getItem('neural_db_v3');
                memoryDB = saved ? JSON.parse(saved) : [];
            } catch(e) { memoryDB = []; }
        }

        function saveMemoryDB() {
            localStorage.setItem('neural_db_v3', JSON.stringify(memoryDB));
            renderDatabaseTable();
        }

        function addMemory(content, category = "Geral") {
            const id = Date.now();
            const date = new Date().toLocaleDateString('pt-BR');
            memoryDB.unshift({ id, date, category, content });
            saveMemoryDB();
            return id;
        }

        window.deleteMemory = (id) => {
            if(confirm("Deletar este registro?")) {
                memoryDB = memoryDB.filter(i => i.id !== id);
                saveMemoryDB();
            }
        };

        window.updateMemory = (id, field, value) => {
            const row = memoryDB.find(i => i.id === id);
            if(row) {
                row[field] = value;
                saveMemoryDB();
            }
        };

        function searchMemory(query) {
            const term = query.toLowerCase();
            return memoryDB.filter(row => 
                row.content.toLowerCase().includes(term) || 
                row.category.toLowerCase().includes(term)
            ).slice(0, 3); // Top 3 resultados
        }

        // --- MOTOR DE CHAT E FERRAMENTAS ---
        window.sendMessage = async () => {
            const input = $('input-box');
            const text = input.value.trim();
            if (!text || !engine) return;

            // 1. UI do UsuÃ¡rio
            appendBubble('user', text);
            input.value = '';
            
            // Adiciona ao histÃ³rico
            chatHistory.push({ role: "user", content: text });
            if (chatHistory.length > MAX_HISTORY) chatHistory.splice(1, 1);

            // 2. Loading
            const loadingId = showLoadingIndicator();
            const scrollBox = $('chat-box');
            scrollBox.scrollTo({ top: scrollBox.scrollHeight, behavior: 'smooth' });

            try {
                // 3. Processamento Neural
                const reply = await engine.chat.completions.create({
                    messages: chatHistory,
                    temperature: 0.7,
                    max_tokens: 1024,
                    stream: false 
                });

                let responseText = reply.choices[0].message.content;
                removeLoadingIndicator(loadingId);

                // --- AGENTE DE FERRAMENTAS ---
                
                // AÃ§Ã£o: Internet
                if (responseText.includes("[YOUTUBE:")) {
                    const term = responseText.match(/\[YOUTUBE: (.*?)\]/)[1];
                    window.open(`https://www.youtube.com/results?search_query=${encodeURIComponent(term)}`, '_blank');
                    responseText = `ðŸŽ¬ Abrindo YouTube para: **${term}**`;
                }
                else if (responseText.includes("[GOOGLE:")) {
                    const term = responseText.match(/\[GOOGLE: (.*?)\]/)[1];
                    window.open(`https://www.google.com/search?q=${encodeURIComponent(term)}`, '_blank');
                    responseText = `ðŸŒ Pesquisando no Google: **${term}**`;
                }

                // AÃ§Ã£o: MemÃ³ria (Salvar)
                if (responseText.includes("[SALVAR_MEMORIA:")) {
                    const content = responseText.match(/\[SALVAR_MEMORIA: (.*?)\]/)[1];
                    addMemory(content);
                    responseText = `ðŸ’¾ *InformaÃ§Ã£o salva no banco de dados com sucesso.*`;
                }

                // AÃ§Ã£o: MemÃ³ria (Ler/RAG)
                if (responseText.includes("[LER_MEMORIA:")) {
                    const term = responseText.match(/\[LER_MEMORIA: (.*?)\]/)[1];
                    const results = searchMemory(term);
                    
                    if (results.length > 0) {
                        const context = JSON.stringify(results);
                        // Injeta conhecimento e pede nova resposta
                        chatHistory.push({ role: "system", content: `CONTEXTO RECUPERADO DA MEMÃ“RIA: ${context}. Use isso para responder.` });
                        const ragReply = await engine.chat.completions.create({ messages: chatHistory });
                        responseText = ragReply.choices[0].message.content;
                    } else {
                        responseText = `NÃ£o encontrei nada sobre "${term}" na minha memÃ³ria.`;
                    }
                }

                // 4. UI da Resposta
                appendBubble('assistant', responseText);
                chatHistory.push({ role: "assistant", content: responseText });

            } catch (e) {
                removeLoadingIndicator(loadingId);
                appendBubble('assistant', "Erro no processamento: " + e.message);
            }
        };

        // --- FUNÃ‡Ã•ES DE UI ---
        function appendBubble(role, text) {
            const box = $('chat-content'); // Container interno
            const div = document.createElement('div');
            const isUser = role === 'user';
            
            div.className = `flex w-full mb-4 animate-fade-in ${isUser ? 'justify-end' : 'justify-start'}`;
            
            const contentHtml = isUser ? text : marked.parse(text);
            
            div.innerHTML = `
                <div class="max-w-[85%] p-4 rounded-2xl shadow-sm text-[15px] leading-relaxed ${
                    isUser 
                    ? 'bg-blue-600 text-white rounded-tr-sm' 
                    : 'bg-gray-800 border border-gray-700 text-gray-200 rounded-tl-sm prose prose-invert'
                }">
                    ${contentHtml}
                </div>
            `;
            box.appendChild(div);
            // Scroll no pai
            $('chat-box').scrollTo({ top: $('chat-box').scrollHeight, behavior: 'smooth' });
        }

        function showLoadingIndicator() {
            const id = 'load-' + Date.now();
            const box = $('chat-content');
            const div = document.createElement('div');
            div.id = id;
            div.className = 'flex w-full mb-4 justify-start animate-fade-in';
            div.innerHTML = `
                <div class="bg-gray-800 border border-gray-700 px-4 py-3 rounded-2xl rounded-tl-sm flex items-center gap-2">
                    <div class="flex gap-1">
                        <div class="w-2 h-2 bg-blue-500 rounded-full animate-bounce"></div>
                        <div class="w-2 h-2 bg-blue-500 rounded-full animate-bounce delay-75"></div>
                        <div class="w-2 h-2 bg-blue-500 rounded-full animate-bounce delay-150"></div>
                    </div>
                </div>`;
            box.appendChild(div);
            return id;
        }

        function removeLoadingIndicator(id) {
            const el = document.getElementById(id);
            if (el) el.remove();
        }

        function renderDatabaseTable() {
            const tbody = $('table-body');
            tbody.innerHTML = '';
            
            if (memoryDB.length === 0) {
                $('empty-state').classList.remove('hidden');
            } else {
                $('empty-state').classList.add('hidden');
                
                memoryDB.forEach(row => {
                    const tr = document.createElement('tr');
                    tr.className = "border-b border-gray-700 hover:bg-gray-750 group";
                    tr.innerHTML = `
                        <td class="p-3 text-gray-500 font-mono text-xs">${row.id.toString().slice(-4)}</td>
                        <td class="p-3 text-blue-400 text-xs">${row.date}</td>
                        <td class="p-3 text-gray-200">
                            <input onchange="window.updateMemory(${row.id}, 'content', this.value)" 
                                   value="${row.content}" 
                                   class="bg-transparent w-full focus:outline-none focus:border-b border-blue-500">
                        </td>
                        <td class="p-3 text-gray-400">
                            <input onchange="window.updateMemory(${row.id}, 'category', this.value)" 
                                   value="${row.category}" 
                                   class="bg-transparent w-full text-xs focus:outline-none focus:border-b border-blue-500">
                        </td>
                        <td class="p-3 text-right">
                            <button onclick="window.deleteMemory(${row.id})" class="text-red-500 opacity-0 group-hover:opacity-100 transition-opacity p-1">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            }
            lucide.createIcons();
            $('record-count').innerText = `${memoryDB.length} registros`;
        }

        // NavegaÃ§Ã£o entre Abas
        window.switchTab = (tab) => {
            if (tab === 'chat') {
                $('view-chat').classList.remove('hidden');
                $('view-db').classList.add('hidden');
                $('btn-chat').classList.add('bg-blue-600', 'text-white');
                $('btn-chat').classList.remove('bg-gray-800', 'text-gray-400');
                $('btn-db').classList.remove('bg-blue-600', 'text-white');
                $('btn-db').classList.add('bg-gray-800', 'text-gray-400');
            } else {
                $('view-chat').classList.add('hidden');
                $('view-db').classList.remove('hidden');
                $('btn-db').classList.add('bg-blue-600', 'text-white');
                $('btn-db').classList.remove('bg-gray-800', 'text-gray-400');
                $('btn-chat').classList.remove('bg-blue-600', 'text-white');
                $('btn-chat').classList.add('bg-gray-800', 'text-gray-400');
                renderDatabaseTable();
            }
        };

        // Listeners
        $('input-box').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') window.sendMessage();
        });

        // Start
        window.onload = initSystem;

    </script>
    <style>
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        body { background: #0f172a; color: white; height: 100dvh; display: flex; flex-direction: column; overflow: hidden; }
        .delay-75 { animation-delay: 75ms; }
        .delay-150 { animation-delay: 150ms; }
    </style>
</head>
<body class="font-sans antialiased">

    <!-- TELA DE CARREGAMENTO -->
    <div id="loading-screen" class="absolute inset-0 z-50 bg-[#0f172a] flex flex-col items-center justify-center p-8 transition-opacity duration-500">
        <div class="relative w-20 h-20 mb-6">
            <div class="absolute inset-0 border-t-4 border-blue-500 rounded-full animate-spin"></div>
            <div class="absolute inset-2 border-r-4 border-purple-500 rounded-full animate-spin"></div>
            <div class="absolute inset-0 flex items-center justify-center">
                <i data-lucide="cpu" class="w-8 h-8 text-white"></i>
            </div>
        </div>
        <h2 class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-purple-400">NeuralOS v2.1</h2>
        <p id="status-text" class="text-gray-400 text-xs font-mono mb-6 mt-2">Inicializando...</p>
        <div class="w-48 h-1 bg-gray-800 rounded-full overflow-hidden">
            <div id="loading-bar" class="h-full bg-blue-500 transition-all duration-300 w-0"></div>
        </div>
    </div>

    <!-- APP PRINCIPAL -->
    <div class="flex-1 flex flex-col relative overflow-hidden">
        
        <!-- HEADER -->
        <header class="h-16 bg-[#1e293b]/80 backdrop-blur border-b border-gray-700 flex items-center justify-between px-4 shrink-0 z-20">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-blue-600 to-indigo-600 flex items-center justify-center shadow-lg">
                    <i data-lucide="brain-circuit" class="text-white w-6 h-6"></i>
                </div>
                <div>
                    <h1 class="font-bold text-sm tracking-wide">Neural<span class="text-blue-400">OS</span></h1>
                    <span class="text-[10px] text-gray-400 bg-gray-800 px-1.5 py-0.5 rounded border border-gray-700">STABLE</span>
                </div>
            </div>
            
            <div class="flex bg-gray-800 p-1 rounded-lg gap-1">
                <button id="btn-chat" onclick="switchTab('chat')" class="px-3 py-1.5 rounded-md text-xs font-bold bg-blue-600 text-white flex items-center gap-2 transition-all">
                    <i data-lucide="message-square" class="w-3 h-3"></i> Chat
                </button>
                <button id="btn-db" onclick="switchTab('db')" class="px-3 py-1.5 rounded-md text-xs font-bold bg-gray-800 text-gray-400 hover:text-white flex items-center gap-2 transition-all">
                    <i data-lucide="sheet" class="w-3 h-3"></i> Excel
                </button>
            </div>
        </header>

        <!-- ABA: CHAT -->
        <div id="view-chat" class="flex-1 flex flex-col relative overflow-hidden">
            <div id="chat-box" class="flex-1 overflow-y-auto pb-24 scroll-smooth">
                <div id="chat-content" class="p-4 pt-6">
                    <!-- Mensagens entram aqui -->
                    <div class="flex justify-center mb-4">
                        <span class="text-[10px] text-gray-500 bg-gray-800/50 px-3 py-1 rounded-full border border-gray-700">
                            Sistema Online â€¢ Llama 3.2 3B
                        </span>
                    </div>
                </div>
            </div>

            <!-- Input -->
            <div class="absolute bottom-0 w-full p-4 bg-gradient-to-t from-[#0f172a] via-[#0f172a] to-transparent z-10">
                <div class="flex items-center gap-2 bg-[#1e293b] border border-gray-700 p-2 rounded-full shadow-2xl">
                    <input id="input-box" type="text" class="flex-1 bg-transparent px-4 py-2 text-sm text-white focus:outline-none placeholder-gray-500" placeholder="Digite aqui...">
                    <button onclick="window.sendMessage()" class="w-10 h-10 bg-blue-600 hover:bg-blue-500 rounded-full flex items-center justify-center text-white shadow-lg transition-transform active:scale-95">
                        <i data-lucide="send" class="w-4 h-4 ml-0.5"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- ABA: BANCO DE DADOS -->
        <div id="view-db" class="hidden flex-1 flex flex-col bg-[#0f172a] overflow-hidden">
            <div class="p-3 bg-[#1e293b] border-b border-gray-700 flex justify-between items-center">
                <h2 class="text-xs font-bold text-gray-300 flex items-center gap-2">
                    <i data-lucide="database" class="w-3 h-3 text-blue-400"></i> MEMÃ“RIA
                </h2>
                <span id="record-count" class="text-[10px] text-gray-500 font-mono">0 registros</span>
            </div>

            <div class="flex-1 overflow-auto">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-gray-800 text-[10px] uppercase text-gray-400 sticky top-0 z-10 shadow-sm">
                        <tr>
                            <th class="p-3 w-16 border-b border-gray-700">ID</th>
                            <th class="p-3 w-24 border-b border-gray-700">Data</th>
                            <th class="p-3 border-b border-gray-700">ConteÃºdo</th>
                            <th class="p-3 w-32 border-b border-gray-700">Categoria</th>
                            <th class="p-3 w-10 border-b border-gray-700"></th>
                        </tr>
                    </thead>
                    <tbody id="table-body" class="text-sm divide-y divide-gray-800">
                        <!-- Linhas -->
                    </tbody>
                </table>

                <div id="empty-state" class="hidden flex flex-col items-center justify-center mt-20 opacity-50">
                    <i data-lucide="table" class="w-12 h-12 text-gray-600 mb-2"></i>
                    <p class="text-sm text-gray-400">Nada salvo.</p>
                </div>
            </div>
        </div>

    </div>

</body>
</html>
