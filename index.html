<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, interactive-widget=resizes-content">
    <title>NeuralOS - Custom Cloud</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/12.0.0/marked.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script type="module">
        import * as webllm from "https://esm.run/@mlc-ai/web-llm";

        // ======================================================
        // ‚öôÔ∏è CONFIGURA√á√ÉO DO SEU SERVIDOR (RENDER)
        // ======================================================
        const RENDER_API_URL = "https://neural-api-3vra.onrender.com"; 
        // ======================================================

        // Identificador do modelo
        const MODEL_ID = "Llama-3.2-3B-Instruct-q4f16_1-MLC";
        const MAX_HISTORY = 10;

        // --- CORRE√á√ÉO DO ERRO 'FIND' ---
        // Definimos manualmente onde est√£o os arquivos para a biblioteca n√£o se perder
        const myAppConfig = {
            model_list: [
                {
                    "model_id": MODEL_ID,
                    "model_lib_url": "https://raw.githubusercontent.com/mlc-ai/binary-mlc-llm-libs/main/webllm-dyn/Llama-3.2-3B-Instruct-q4f16_1-MLC-webgpu.wasm",
                    "model_url": "https://huggingface.co/mlc-ai/Llama-3.2-3B-Instruct-q4f16_1-MLC/resolve/main/",
                    "vram_required_MB": 3000,
                    "low_resource_required": false,
                }
            ],
            use_indexed_db_cache: true
        };

        let engine = null;
        let chatHistory = [];
        let isOnlineDB = false;
        
        const $ = (id) => document.getElementById(id);

        // --- SISTEMA DE BANCO DE DADOS (API PR√ìPRIA) ---
        const DB = {
            wakeUp: async () => {
                if (!RENDER_API_URL) return false;
                try {
                    $('status-text').innerText = "Acordando servidor no Render...";
                    $('status-text').className = "text-yellow-400 text-xs font-mono mb-6 mt-2 animate-pulse";
                    
                    // O Render demora at√© 60s para acordar do plano free
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 60000);
                    
                    const res = await fetch(`${RENDER_API_URL}/wake-up`, { signal: controller.signal });
                    clearTimeout(timeoutId);
                    
                    if (res.ok) {
                        isOnlineDB = true;
                        console.log("Servidor Acordado!");
                        return true;
                    }
                } catch (e) {
                    console.warn("Falha ao conectar no Render. Usando modo local.", e);
                }
                return false;
            },

            add: async (text) => {
                if (isOnlineDB) {
                    try {
                        await fetch(`${RENDER_API_URL}/memories`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ content: text })
                        });
                        showToast("Salvo na Nuvem Pr√≥pria");
                        DB.refreshList();
                    } catch(e) { showToast("Erro ao salvar na nuvem"); }
                } else {
                    // Fallback Local
                    const local = JSON.parse(localStorage.getItem('neural_local_db') || '[]');
                    local.unshift({ id: Date.now(), content: text, date: new Date().toISOString() });
                    localStorage.setItem('neural_local_db', JSON.stringify(local));
                    showToast("Salvo Localmente (Sem API)");
                    DB.refreshList();
                }
            },

            search: async (term) => {
                if (isOnlineDB) {
                    try {
                        const res = await fetch(`${RENDER_API_URL}/memories?search=${encodeURIComponent(term)}`);
                        const data = await res.json();
                        return data.map(m => m.content);
                    } catch(e) { return []; }
                } else {
                    const local = JSON.parse(localStorage.getItem('neural_local_db') || '[]');
                    return local
                        .filter(m => m.content.toLowerCase().includes(term.toLowerCase()))
                        .map(m => m.content)
                        .slice(0, 3);
                }
            },

            refreshList: async () => {
                const list = $('memory-list');
                list.innerHTML = '<div class="text-center text-xs text-gray-400 mt-4">Carregando...</div>';
                let items = [];

                if (isOnlineDB) {
                    try {
                        const res = await fetch(`${RENDER_API_URL}/memories`);
                        items = await res.json();
                        $('db-status-indicator').innerHTML = '<span class="text-green-500 font-bold">‚óè Online (Render)</span>';
                    } catch(e) { items = []; }
                } else {
                    items = JSON.parse(localStorage.getItem('neural_local_db') || '[]');
                    $('db-status-indicator').innerHTML = '<span class="text-yellow-500 font-bold">‚óè Offline (Local)</span>';
                }

                list.innerHTML = '';
                $('mem-count').innerText = items.length;

                if (items.length === 0) {
                    list.innerHTML = `<div class="text-center text-gray-400 text-xs mt-10">Mem√≥ria vazia.</div>`;
                    return;
                }

                items.forEach(item => {
                    const el = document.createElement('div');
                    el.className = "bg-white p-3 rounded-lg border border-gray-100 shadow-sm flex flex-col items-start text-sm text-gray-700 mb-2 hover:border-indigo-200 transition-colors";
                    el.innerHTML = `
                        <span class="font-medium text-gray-800">${item.content}</span>
                        <div class="flex justify-between w-full mt-2 border-t border-gray-50 pt-2">
                            <span class="text-[10px] text-gray-400">${new Date(item.date).toLocaleDateString()}</span>
                            ${!isOnlineDB ? `<button onclick="window.delLocal(${item.id})" class="text-red-400 text-[10px] hover:text-red-600">Apagar</button>` : ''}
                        </div>
                    `;
                    list.appendChild(el);
                });
            }
        };

        // Helpers globais
        window.delLocal = (id) => {
            let local = JSON.parse(localStorage.getItem('neural_local_db') || '[]');
            local = local.filter(m => m.id !== id);
            localStorage.setItem('neural_local_db', JSON.stringify(local));
            DB.refreshList();
        }

        // --- SISTEMA WEB (APIs Gratuitas) ---
        const WebAgent = {
            searchWiki: async (q) => {
                try {
                    const res = await fetch(`https://pt.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(q)}`);
                    if(!res.ok) return null;
                    const data = await res.json();
                    return data.type === 'standard' ? data.extract : null;
                } catch(e) { return null; }
            }
        };

        // --- INICIALIZA√á√ÉO ---
        async function initSystem() {
            // 1. Tenta acordar o servidor enquanto baixa a IA
            const wakeUpPromise = DB.wakeUp();

            $('status-text').innerText = "Carregando C√©rebro...";
            $('loading-bar').style.width = "10%";

            const initProgressCallback = (report) => {
                const text = report.text;
                if(text.includes("Fetching")) {
                    const pct = text.match(/(\d+)%/) ? text.match(/(\d+)%/)[1] : "0";
                    $('status-text').innerText = `Baixando IA (${pct}%)...`;
                    $('loading-bar').style.width = pct + "%";
                } else if (text.includes("Loading")) {
                     $('status-text').innerText = "Carregando na RAM...";
                     $('loading-bar').style.width = "90%";
                } else if (text.includes("Finish")) {
                     $('loading-bar').style.width = "100%";
                }
            };

            try {
                if (!navigator.gpu) throw new Error("GPU WebGPU n√£o detectada.");

                // 2. Carrega IA com CONFIGURA√á√ÉO EXPL√çCITA
                engine = await webllm.CreateMLCEngine(
                    MODEL_ID,
                    { 
                        appConfig: myAppConfig, // <--- AQUI EST√Å A CORRE√á√ÉO
                        initProgressCallback: initProgressCallback,
                        logLevel: "WARN"
                    }
                );

                await engine.chat.completions.create({ messages: [{ role: "user", content: "hi" }], max_tokens: 1 });
                
                // Aguarda o servidor acordar (ou timeout)
                await wakeUpPromise;
                DB.refreshList();

                // UI Ready
                $('loading-screen').classList.add('opacity-0', 'pointer-events-none');
                setTimeout(() => $('loading-screen').style.display = 'none', 500);
                lucide.createIcons();

                // Prompt
                chatHistory = [{ 
                    role: "system", 
                    content: `
Voc√™ √© o NeuralOS.
REGRAS:
1. Responda em Portugu√™s.
2. Comandos OBRIGAT√ìRIOS para a√ß√µes:
   - [MEM: fato] -> Salvar mem√≥ria nova.
   - [WIKI: termo] -> Pesquisar significado/hist√≥ria.
   - [YOUTUBE: termo] -> V√≠deos/M√∫sica.
   - [GOOGLE: termo] -> Pesquisa gen√©rica.
3. Se o usu√°rio perguntar algo pessoal, verifique o contexto fornecido.
` 
                }];

            } catch (err) {
                $('status-text').innerText = "Erro: " + err.message;
                $('status-text').className = "text-red-500 text-xs font-bold";
                
                // Bot√£o de limpar cache em caso de erro persistente
                const btn = document.createElement("button");
                btn.className = "mt-4 bg-red-600 text-white px-4 py-2 rounded text-xs";
                btn.innerText = "Limpar Cache e Reiniciar";
                btn.onclick = async () => {
                    if(confirm("Isso apagar√° o modelo baixado e baixar√° novamente. Continuar?")) {
                        const dbs = await window.indexedDB.databases();
                        dbs.forEach(db => window.indexedDB.deleteDatabase(db.name));
                        window.location.reload();
                    }
                };
                $('loading-screen').appendChild(btn);
            }
        }

        window.sendMessage = async () => {
            const input = $('input-box');
            const text = input.value.trim();
            if (!text || !engine) return;

            appendBubble('user', text);
            input.value = '';

            // RAG (Busca Mem√≥ria)
            const memories = await DB.search(text);
            let context = "";
            if (memories.length > 0) context = `CONTEXTO DA MEM√ìRIA: ${memories.join(' | ')}.`;

            const tempHistory = [
                ...chatHistory, 
                { role: "system", content: context || "Sem mem√≥rias sobre isso." },
                { role: "user", content: text }
            ];

            const loadingId = showLoadingIndicator();

            try {
                // 1. Decis√£o
                const reply = await engine.chat.completions.create({
                    messages: tempHistory,
                    temperature: 0.1,
                    max_tokens: 256,
                });
                
                let responseText = reply.choices[0].message.content;
                let externalData = null;

                // 2. Ferramentas
                if (responseText.includes("[WIKI:")) {
                    updateLoadingText(loadingId, "Lendo Wikipedia...");
                    const term = responseText.match(/\[WIKI: (.*?)\]/)[1];
                    const wikiData = await WebAgent.searchWiki(term);
                    if (wikiData) externalData = `Wikipedia sobre ${term}: ${wikiData}`;
                    else externalData = "Sem dados na Wiki.";
                }

                if (responseText.includes("[MEM:")) {
                    const content = responseText.match(/\[MEM: (.*?)\]/)[1];
                    await DB.add(content);
                    externalData = `(Salvo no servidor: "${content}")`;
                }

                if (responseText.includes("[YOUTUBE:")) {
                    const term = responseText.match(/\[YOUTUBE: (.*?)\]/)[1];
                    window.open(`https://www.youtube.com/results?search_query=${encodeURIComponent(term)}`, '_blank');
                    responseText = `üé¨ Abrindo YouTube: **${term}**`;
                }

                if (responseText.includes("[GOOGLE:")) {
                    const term = responseText.match(/\[GOOGLE: (.*?)\]/)[1];
                    window.open(`https://www.google.com/search?q=${encodeURIComponent(term)}`, '_blank');
                    responseText = `üåê Pesquisando no Google: **${term}**`;
                }

                // 3. Resposta Final
                if (externalData) {
                    updateLoadingText(loadingId, "Formulando resposta...");
                    tempHistory.push({ role: "assistant", content: responseText });
                    tempHistory.push({ role: "system", content: `DADO OBTIDO: ${externalData}. Responda ao usu√°rio.` });
                    
                    const finalReply = await engine.chat.completions.create({
                        messages: tempHistory,
                        temperature: 0.7,
                    });
                    responseText = finalReply.choices[0].message.content;
                }

                removeLoadingIndicator(loadingId);
                appendBubble('assistant', responseText);
                
                chatHistory.push({ role: "user", content: text });
                chatHistory.push({ role: "assistant", content: responseText });
                if (chatHistory.length > MAX_HISTORY) chatHistory.splice(1, 2);

            } catch (e) {
                removeLoadingIndicator(loadingId);
                appendBubble('assistant', "Erro: " + e.message);
            }
        };

        // UI Utils
        function appendBubble(role, text) {
            const box = $('chat-content');
            const div = document.createElement('div');
            const isUser = role === 'user';
            div.className = `flex w-full mb-4 animate-fade-in ${isUser ? 'justify-end' : 'justify-start'} text-sm`;
            div.innerHTML = `
                <div class="max-w-[85%] p-3.5 rounded-2xl shadow-sm leading-relaxed ${
                    isUser ? 'bg-indigo-600 text-white rounded-tr-sm' : 'bg-white border border-gray-100 text-gray-800 rounded-tl-sm prose prose-sm'
                }">${isUser ? text : marked.parse(text)}</div>
            `;
            box.appendChild(div);
            $('chat-box').scrollTo({ top: $('chat-box').scrollHeight, behavior: 'smooth' });
        }

        function showLoadingIndicator() {
            const id = 'load-' + Date.now();
            const box = $('chat-content');
            const div = document.createElement('div');
            div.id = id;
            div.className = 'flex w-full mb-4 justify-start animate-fade-in';
            div.innerHTML = `
                <div class="bg-white border border-gray-100 px-4 py-2 rounded-2xl rounded-tl-sm flex items-center gap-3">
                    <div class="flex gap-1">
                        <span class="w-1.5 h-1.5 bg-indigo-500 rounded-full animate-bounce"></span>
                        <span class="w-1.5 h-1.5 bg-indigo-500 rounded-full animate-bounce delay-75"></span>
                        <span class="w-1.5 h-1.5 bg-indigo-500 rounded-full animate-bounce delay-150"></span>
                    </div>
                    <span class="text-xs text-gray-400 font-mono" id="${id}-text">Pensando...</span>
                </div>`;
            box.appendChild(div);
            return id;
        }

        function updateLoadingText(id, text) {
            const el = document.getElementById(id + '-text');
            if (el) el.innerText = text;
        }

        function removeLoadingIndicator(id) {
            const el = document.getElementById(id);
            if (el) el.remove();
        }

        function showToast(msg) {
            const t = document.createElement('div');
            t.className = "fixed top-4 left-1/2 -translate-x-1/2 bg-gray-900 text-white text-xs px-4 py-2 rounded-full shadow-lg z-50 animate-fade-in";
            t.innerText = msg;
            document.body.appendChild(t);
            setTimeout(() => t.remove(), 2000);
        }

        window.switchTab = (tab) => {
            if (tab === 'chat') {
                $('view-chat').classList.remove('hidden');
                $('view-mem').classList.add('hidden');
                $('btn-chat').classList.add('bg-indigo-100', 'text-indigo-700');
                $('btn-mem').classList.remove('bg-indigo-100', 'text-indigo-700');
            } else {
                $('view-chat').classList.add('hidden');
                $('view-mem').classList.remove('hidden');
                $('btn-mem').classList.add('bg-indigo-100', 'text-indigo-700');
                $('btn-chat').classList.remove('bg-indigo-100', 'text-indigo-700');
                DB.refreshList();
            }
        };

        $('input-box').addEventListener('keypress', (e) => { if (e.key === 'Enter') window.sendMessage(); });
        window.onload = initSystem;
    </script>
    <style>
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        body { background: #f8fafc; height: 100dvh; display: flex; flex-direction: column; overflow: hidden; }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 2px; }
    </style>
</head>
<body class="font-sans antialiased bg-slate-50 text-slate-800">

    <!-- LOADING INICIAL -->
    <div id="loading-screen" class="absolute inset-0 z-50 bg-white flex flex-col items-center justify-center p-8 transition-opacity duration-500">
        <div class="w-16 h-16 mb-6 rounded-2xl bg-indigo-600 flex items-center justify-center shadow-lg shadow-indigo-200">
            <i data-lucide="server" class="text-white w-8 h-8"></i>
        </div>
        <h2 class="text-xl font-bold text-gray-800 mb-1">NeuralOS <span class="text-indigo-600">Render</span></h2>
        <p id="status-text" class="text-gray-400 text-xs font-mono mb-8">Conectando...</p>
        <div class="w-48 h-1 bg-gray-100 rounded-full overflow-hidden">
            <div id="loading-bar" class="h-full bg-indigo-600 transition-all duration-300 w-0"></div>
        </div>
    </div>

    <!-- APP -->
    <div class="flex-1 flex flex-col relative overflow-hidden bg-white max-w-md mx-auto w-full shadow-2xl h-full border-x border-gray-100">
        
        <!-- HEADER -->
        <header class="h-16 bg-white/80 backdrop-blur border-b border-gray-100 flex items-center justify-between px-4 shrink-0 z-20">
            <div class="flex items-center gap-2">
                <div class="w-9 h-9 rounded-xl bg-gradient-to-br from-indigo-600 to-violet-600 flex items-center justify-center text-white shadow-md">
                    <i data-lucide="zap" class="w-5 h-5"></i>
                </div>
                <div>
                    <h1 class="font-bold text-sm text-gray-800">NeuralOS</h1>
                    <div id="db-status-indicator" class="text-[10px] text-gray-400 font-medium">‚óè Local (Offline)</div>
                </div>
            </div>
            
            <div class="flex bg-gray-50 p-1 rounded-full border border-gray-100">
                <button id="btn-chat" onclick="switchTab('chat')" class="px-4 py-1.5 rounded-full text-xs font-bold bg-indigo-100 text-indigo-700 flex items-center gap-2 transition-all">Chat</button>
                <button id="btn-mem" onclick="switchTab('mem')" class="px-4 py-1.5 rounded-full text-xs font-bold text-gray-500 hover:text-indigo-600 flex items-center gap-2 transition-all">
                    Banco <span id="mem-count" class="ml-1 bg-gray-200 px-1.5 rounded-full text-[9px]">0</span>
                </button>
            </div>
        </header>

        <!-- CHAT VIEW -->
        <div id="view-chat" class="flex-1 flex flex-col relative overflow-hidden bg-slate-50">
            <div id="chat-box" class="flex-1 overflow-y-auto pb-24 scroll-smooth">
                <div id="chat-content" class="p-4 pt-6 space-y-4">
                    <div class="flex justify-center">
                        <span class="text-[10px] text-gray-400 bg-white border border-gray-200 px-3 py-1 rounded-full shadow-sm">
                            API Pr√≥pria ‚Ä¢ Wiki ‚Ä¢ YouTube
                        </span>
                    </div>
                </div>
            </div>

            <!-- Input Area -->
            <div class="absolute bottom-0 w-full p-4 bg-gradient-to-t from-slate-50 via-slate-50 to-transparent z-10">
                <div class="flex items-center gap-2 bg-white border border-gray-200 p-1.5 pl-4 rounded-full shadow-xl">
                    <input id="input-box" type="text" class="flex-1 bg-transparent text-sm text-gray-800 focus:outline-none placeholder-gray-400" placeholder="Pergunte sobre o tempo, fatos...">
                    <button onclick="window.sendMessage()" class="w-10 h-10 bg-indigo-600 hover:bg-indigo-500 rounded-full flex items-center justify-center text-white shadow-lg transition-transform active:scale-95">
                        <i data-lucide="arrow-up" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- MEMORY VIEW -->
        <div id="view-mem" class="hidden flex-1 flex flex-col bg-white overflow-hidden">
            <div class="p-4 bg-gray-50 border-b border-gray-100">
                <h3 class="font-bold text-xs text-gray-500 uppercase tracking-wider">Banco de Dados</h3>
                <p class="text-[10px] text-gray-400 mt-1">Registros salvos automaticamente ou manualmente.</p>
            </div>
            <div id="memory-list" class="flex-1 overflow-y-auto p-4">
                <!-- Items -->
            </div>
        </div>

    </div>

</body>
</html>
