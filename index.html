<!DOCTYPE html>
<html lang="pt-BR" class="h-full w-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, interactive-widget=resizes-content">
    <title>NeuralOS v7.5 - Stable</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/12.0.0/marked.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- jsPDF (Vers√£o Global Compat√≠vel) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- Python Engine -->
    <script src="https://cdn.jsdelivr.net/pyodide/v0.25.0/full/pyodide.js"></script>
    
    <script type="module">
        import * as webllm from "https://cdn.jsdelivr.net/npm/@mlc-ai/web-llm@0.2.72/+esm";

        // --- CONFIGURA√á√ÉO ---
        const RENDER_API_URL = "https://neural-api-3vra.onrender.com"; 
        const MODEL_ID = "Llama-3.2-3B-Instruct-q4f16_1-MLC";
        const MAX_HISTORY = 15;

        // --- ESTADO GLOBAL ---
        let engine = null;
        let chatHistory = [];
        let isOnlineDB = false;
        let isOfflineMode = false;
        let recognition = null;
        let availableVoices = [];
        let currentCanvasCode = ""; 
        let pyodideInstance = null;
        
        // Carregamento de Configura√ß√µes (Robusto)
        let userConfig = {
            name: 'Usu√°rio',
            vibe: 'Assistente Padr√£o',
            ttsEnabled: false,
            voiceIndex: 0,
            amoled: false
        };

        // Fun√ß√£o segura para ler do storage
        function loadConfigs() {
            try {
                if(localStorage.getItem('neural_user_name')) userConfig.name = localStorage.getItem('neural_user_name');
                if(localStorage.getItem('neural_ai_vibe')) userConfig.vibe = localStorage.getItem('neural_ai_vibe');
                if(localStorage.getItem('neural_tts')) userConfig.ttsEnabled = localStorage.getItem('neural_tts') === 'true';
                if(localStorage.getItem('neural_voice_idx')) userConfig.voiceIndex = parseInt(localStorage.getItem('neural_voice_idx'));
                if(localStorage.getItem('neural_amoled')) userConfig.amoled = localStorage.getItem('neural_amoled') === 'true';
                console.log("Configs carregadas:", userConfig);
            } catch(e) {
                console.warn("Erro ao ler configura√ß√µes:", e);
            }
        }
        loadConfigs(); // Executa imediatamente

        const $ = (id) => document.getElementById(id);

        // --- SISTEMA DE TEMA (APLICA√á√ÉO IMEDIATA) ---
        function applyTheme() {
            const body = document.body;
            const appContainer = $('main-app-container');
            const inputContainer = $('input-container');
            const inputWrapper = $('input-wrapper');
            const headers = document.querySelectorAll('header');
            const modals = document.querySelectorAll('.modal-bg');
            const inputBox = $('input-box');
            
            if (!body) return;

            if (userConfig.amoled) {
                // MODO ESCURO (Preto Real)
                body.className = "font-sans antialiased bg-black text-gray-200 h-full w-full overflow-hidden flex flex-col";
                if(appContainer) appContainer.className = "flex-1 flex flex-col relative overflow-hidden max-w-md mx-auto w-full h-full shadow-2xl bg-black border-x border-gray-800";
                
                if(inputContainer) inputContainer.className = "w-full p-4 bg-black z-10 transition-colors shrink-0 border-t border-gray-800";
                if(inputWrapper) inputWrapper.className = "flex items-center gap-2 border p-1.5 pl-2 rounded-full shadow-sm bg-gray-900 border-gray-700";
                
                headers.forEach(h => h.className = "h-14 backdrop-blur border-b flex items-center justify-between px-4 shrink-0 z-20 transition-colors bg-black/90 border-gray-800");
                modals.forEach(m => m.classList.replace('bg-white', 'bg-gray-900'));
                
                if(inputBox) {
                    inputBox.classList.remove('text-gray-800', 'placeholder-gray-400');
                    inputBox.classList.add('text-white', 'placeholder-gray-600');
                }
            } else {
                // MODO CLARO
                body.className = "font-sans antialiased bg-slate-50 text-slate-800 h-full w-full overflow-hidden flex flex-col";
                if(appContainer) appContainer.className = "flex-1 flex flex-col relative overflow-hidden max-w-md mx-auto w-full h-full shadow-2xl bg-white border-x border-gray-100";
                
                if(inputContainer) inputContainer.className = "w-full p-4 bg-white z-10 transition-colors shrink-0 border-t border-gray-100";
                if(inputWrapper) inputWrapper.className = "flex items-center gap-2 border p-1.5 pl-2 rounded-full shadow-sm bg-white border-gray-200";
                
                headers.forEach(h => h.className = "h-14 backdrop-blur border-b flex items-center justify-between px-4 shrink-0 z-20 transition-colors bg-white/90 border-gray-100");
                modals.forEach(m => m.classList.replace('bg-gray-900', 'bg-white'));
                
                if(inputBox) {
                    inputBox.classList.remove('text-white', 'placeholder-gray-600');
                    inputBox.classList.add('text-gray-800', 'placeholder-gray-400');
                }
            }
        }

        // --- SISTEMA DE √ÅUDIO ---
        function loadVoices() {
            availableVoices = window.speechSynthesis.getVoices();
            const voiceSelect = $('select-voice');
            if(!voiceSelect) return;
            
            voiceSelect.innerHTML = '';
            const ptVoices = availableVoices.filter(v => v.lang.includes('pt') || v.lang.includes('BR'));
            const voicesToUse = ptVoices.length > 0 ? ptVoices : availableVoices;
            
            voicesToUse.forEach((voice, index) => {
                const option = document.createElement('option');
                option.value = index; 
                option.textContent = `${voice.name}`;
                if(index === userConfig.voiceIndex) option.selected = true;
                voiceSelect.appendChild(option);
            });
        }
        window.speechSynthesis.onvoiceschanged = loadVoices;

        function speak(text) {
            if (!userConfig.ttsEnabled || !text) return;
            const cleanText = text.replace(/[*#_\[\]`]/g, '').replace(/https?:\/\/\S+/g, 'link');
            const utterance = new SpeechSynthesisUtterance(cleanText);
            
            const ptVoices = availableVoices.filter(v => v.lang.includes('pt') || v.lang.includes('BR'));
            const voicesList = ptVoices.length > 0 ? ptVoices : availableVoices;
            utterance.voice = voicesList[userConfig.voiceIndex] || availableVoices[0];
            
            utterance.rate = 1.2; 
            window.speechSynthesis.cancel(); 
            window.speechSynthesis.speak(utterance);
        }

        // --- SISTEMA CANVAS ---
        window.openCanvas = (code, type) => {
            currentCanvasCode = code; 
            const modal = $('canvas-modal');
            const container = $('canvas-container');
            const consoleDiv = $('canvas-console');
            
            container.innerHTML = ''; 
            consoleDiv.innerHTML = '<div class="text-gray-500 italic">Console pronto...</div>';
            
            if (type === 'html') {
                const iframe = document.createElement('iframe');
                iframe.className = "w-full h-full bg-white rounded-lg border-0";
                container.appendChild(iframe);
                
                const errorCaptureScript = `<script>
                    window.onerror = function(message, source, lineno, colno, error) {
                        window.parent.postMessage({type: 'error', message: message, line: lineno}, '*');
                    };
                    console.log = function(message) {
                        window.parent.postMessage({type: 'log', message: message}, '*');
                    };
                <\/script>`;
                
                const doc = iframe.contentWindow.document;
                doc.open();
                doc.write(errorCaptureScript + code);
                doc.close();
            } else {
                const pre = document.createElement('pre');
                pre.className = "w-full h-full bg-gray-900 text-green-400 p-4 overflow-auto rounded-lg font-mono text-sm";
                pre.innerText = code;
                container.appendChild(pre);
            }
            
            modal.classList.remove('hidden');
        };

        window.addEventListener('message', (event) => {
            const consoleDiv = $('canvas-console');
            if(!consoleDiv) return;
            if (event.data.type === 'error') {
                consoleDiv.innerHTML += `<div class="text-red-400 mt-1">‚ùå Erro: ${event.data.message}</div>`;
                $('fix-code-btn').classList.remove('hidden'); 
                $('fix-code-btn').dataset.error = event.data.message;
            } else if (event.data.type === 'log') {
                consoleDiv.innerHTML += `<div class="text-blue-300 mt-1">‚ÑπÔ∏è ${event.data.message}</div>`;
            }
        });

        window.fixCanvasCode = () => {
            const errorMsg = $('fix-code-btn').dataset.error;
            window.closeCanvas();
            const prompt = `O c√≥digo gerado deu erro: "${errorMsg}". Corrija e reenvie:\n\n${currentCanvasCode}`;
            $('input-box').value = prompt;
            window.sendMessage();
        };

        window.closeCanvas = () => {
            $('canvas-modal').classList.add('hidden');
            $('canvas-container').innerHTML = ''; 
            $('fix-code-btn').classList.add('hidden');
        };

        // --- SISTEMA DE PDF (jsPDF Otimizado e Ass√≠ncrono) ---
        const Tools = {
            generatePDF: async (title, content) => {
                showToast("Gerando PDF...");
                
                // Retorna uma Promise para garantir que o await no sendMessage funcione
                return new Promise((resolve) => {
                    setTimeout(() => {
                        try {
                            // Verifica se jsPDF carregou
                            if (!window.jspdf || !window.jspdf.jsPDF) {
                                resolve("Erro: Biblioteca PDF n√£o carregada. Tente recarregar.");
                                return;
                            }

                            const { jsPDF } = window.jspdf;
                            const doc = new jsPDF();
                            
                            const pageWidth = doc.internal.pageSize.getWidth();
                            const pageHeight = doc.internal.pageSize.getHeight();
                            const margin = 20;
                            const maxLineWidth = pageWidth - (margin * 2);
                            
                            // T√≠tulo
                            doc.setFontSize(22);
                            doc.setTextColor(40, 40, 40);
                            doc.text(title || "Documento NeuralOS", margin, 20);
                            
                            doc.setLineWidth(0.5);
                            doc.line(margin, 25, pageWidth - margin, 25);
                            
                            // Conte√∫do
                            doc.setFontSize(12);
                            doc.setTextColor(60, 60, 60);
                            
                            const cleanContent = content.replace(/\*\*/g, "").replace(/#/g, "").replace(/`/g, "");
                            const lines = doc.splitTextToSize(cleanContent, maxLineWidth);
                            
                            let cursorY = 35;
                            const lineHeight = 7;
                            
                            lines.forEach(line => {
                                if (cursorY + lineHeight > pageHeight - margin) {
                                    doc.addPage();
                                    cursorY = 20;
                                }
                                doc.text(line, margin, cursorY);
                                cursorY += lineHeight;
                            });
                            
                            const fileName = `${(title || 'doc').substring(0, 15).replace(/[^a-z0-9]/gi, '_')}.pdf`;
                            doc.save(fileName);
                            
                            resolve(`PDF "${fileName}" baixado com sucesso.`);
                        } catch (e) {
                            console.error(e);
                            resolve("Erro ao criar PDF: " + e.message);
                        }
                    }, 500); // Pequeno delay para garantir que o toast apare√ßa
                });
            },
            
            runPython: async (code) => {
                showToast("Inicializando Python...");
                try {
                    if (!pyodideInstance) {
                        pyodideInstance = await loadPyodide();
                    }
                    pyodideInstance.setStdout({ batched: (msg) => console.log(msg) });
                    const result = await pyodideInstance.runPythonAsync(code);
                    return result !== undefined ? String(result) : "Executado (verifique logs).";
                } catch (e) {
                    return "Erro Python: " + e.message;
                }
            },

            scheduleAlert: async (minutes, message) => {
                const ms = parseFloat(minutes) * 60000;
                if (isNaN(ms)) return "Tempo inv√°lido.";
                
                if (Notification.permission !== 'granted') await Notification.requestPermission();
                
                setTimeout(() => {
                    new Notification("Lembrete NeuralOS", { body: message });
                    speak(`Lembrete: ${message}`);
                }, ms);
                
                return `Alerta definido para ${minutes} min.`;
            },

            weather: async (city) => {
                if(isOfflineMode) return "Sem internet.";
                try {
                    const geo = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(city)}&count=1&language=pt&format=json`).then(r=>r.json());
                    if(!geo.results) return null;
                    const {latitude, longitude, name} = geo.results[0];
                    const w = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current=temperature_2m,relative_humidity_2m&timezone=auto`).then(r=>r.json());
                    return `${name}: ${w.current.temperature_2m}¬∞C, Umidade ${w.current.relative_humidity_2m}%.`;
                } catch(e) { return null; }
            },
            
            wiki: async (term) => {
                if(isOfflineMode) return "Sem internet.";
                try {
                    const res = await fetch(`https://pt.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(term)}`);
                    if(!res.ok) return null;
                    return (await res.json()).extract;
                } catch(e) { return null; }
            }
        };

        // --- CORE ---
        function updateSystemPrompt() {
            let persona = "Seja um assistente √∫til.";
            if (userConfig.vibe === 'Jarvis') persona = "Aja como JARVIS. T√©cnico e preciso.";
            if (userConfig.vibe === 'Amigo') persona = "Seja casual, melhor amigo.";
            
            chatHistory[0] = { 
                role: "system", 
                content: `
Voc√™ √© o NeuralOS v7.5. USU√ÅRIO: ${userConfig.name}. PERSONALIDADE: ${persona}.
DIRETRIZES:
1. Pense antes de responder: <pensamento>...</pensamento>.
2. Ferramentas: [PDF: titulo | conteudo], [PYTHON: codigo], [ALERTA: min | texto], [IMG: prompt], [CLIMA: cidade], [WIKI: termo], [MEM: fato], [YOUTUBE: termo], [GOOGLE: termo].
3. C√≥digos visuais em \`\`\`html.
` 
            };
        }

        async function initSystem() {
            applyTheme(); // Aplica tema visual imediatamente
            
            const wakeUpPromise = DB.wakeUp();
            updateSystemPrompt(); 

            $('status-text').innerText = "Carregando...";
            $('loading-bar').style.width = "10%";

            try {
                if (!navigator.gpu) throw new Error("Sem WebGPU.");

                engine = await webllm.CreateMLCEngine(
                    MODEL_ID,
                    { 
                        initProgressCallback: (report) => {
                            if(report.text.includes("Fetching")) $('status-text').innerText = "Baixando...";
                            else if(report.text.includes("Loading")) $('status-text').innerText = "Carregando...";
                            $('loading-bar').style.width = "70%";
                        },
                        logLevel: "WARN",
                    }
                );

                await engine.chat.completions.create({ messages: [{ role: "user", content: "hi" }], max_tokens: 1 });
                await wakeUpPromise;
                DB.refreshList();

                $('loading-screen').classList.add('opacity-0', 'pointer-events-none');
                setTimeout(() => $('loading-screen').style.display = 'none', 500);
                lucide.createIcons();
                loadVoices();
                
                // Aviso de boas vindas com configura√ß√µes carregadas
                if (userConfig.name !== "Usu√°rio") {
                    showToast(`Configura√ß√µes carregadas: ${userConfig.name}`);
                }

            } catch (err) {
                $('status-text').innerText = "Erro: " + err.message;
                $('status-text').className = "text-red-500 font-bold";
            }
        }

        window.sendMessage = async () => {
            const input = $('input-box');
            let text = input.value.trim();
            
            if (window.pendingFileContext) {
                text = `${window.pendingFileContext}\n\n${text}`;
                window.pendingFileContext = null;
                $('attach-btn').classList.remove('text-green-500');
                $('file-upload').value = '';
            }

            if (!text || !engine) return;

            const displayUserText = text.length > 500 ? text.slice(text.lastIndexOf('\n')+1) + " (Com anexo)" : text;
            appendBubble('user', displayUserText);
            input.value = '';

            const memories = await DB.search(text);
            const context = memories.length > 0 ? `[Mem√≥ria: ${memories.join(' | ')}]` : "";
            if (context) text = `${context}\n${text}`;

            const tempHistory = [...chatHistory, { role: "user", content: text }];
            const loadingId = showLoading();

            try {
                const reply = await engine.chat.completions.create({
                    messages: tempHistory,
                    temperature: 0.3,
                    max_tokens: 1024,
                });
                
                let raw = reply.choices[0].message.content;
                let final = raw;
                let toolResult = null;

                const thoughtMatch = raw.match(/<pensamento>(.*?)<\/pensamento>/s);
                if (thoughtMatch) {
                    appendBubble('thought', thoughtMatch[1]);
                    final = raw.replace(/<pensamento>.*?<\/pensamento>/s, "").trim();
                }

                // Parser de Ferramentas
                if (final.includes("[PDF:")) {
                    updateLoading(loadingId, "Gerando PDF...");
                    const match = final.match(/\[PDF: (.*?)\s*\|\s*([\s\S]*?)\]/);
                    if (match) {
                        // Await garante que o PDF termine antes de seguir
                        const result = await Tools.generatePDF(match[1], match[2]);
                        
                        // CORRE√á√ÉO: Remove o loading imediatamente ap√≥s gerar o PDF e encerra o fluxo
                        removeLoading(loadingId);
                        appendBubble('assistant', `üìÑ ${result}`);
                        chatHistory.push({ role: "user", content: text });
                        chatHistory.push({ role: "assistant", content: `Gerei o PDF "${match[1]}".` });
                        return; // SAI DA FUN√á√ÉO PARA N√ÉO TRAVAR
                    } else { 
                        toolResult = "Erro formato PDF."; 
                    }
                }
                else if (final.includes("[PYTHON:")) {
                    updateLoading(loadingId, "Rodando Python...");
                    const code = final.match(/\[PYTHON: ([\s\S]*?)\]/)[1];
                    toolResult = await Tools.runPython(code);
                    final = final.replace(/\[PYTHON:.*?\]/s, `üêç Sa√≠da: \`${toolResult}\``);
                }
                else if (final.includes("[ALERTA:")) {
                    const match = final.match(/\[ALERTA: (.*?)\s*\|\s*(.*?)\]/);
                    if (match) {
                        toolResult = await Tools.scheduleAlert(match[1], match[2]);
                        final = final.replace(/\[ALERTA:.*?\]/s, `‚è∞ ${toolResult}`);
                    }
                }
                else if (final.includes("[IMG:")) {
                    const prompt = final.match(/\[IMG: (.*?)\]/)[1];
                    const imgUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(prompt)}`;
                    final = final.replace(/\[IMG:.*?\]/, `üé® Imagem:<br><img src="${imgUrl}" class="mt-2 rounded-lg w-full h-auto shadow-md" alt="${prompt}">`);
                }
                else if (final.includes("[CLIMA:")) {
                    const city = final.match(/\[CLIMA: (.*?)\]/)[1];
                    toolResult = await Tools.weather(city) || "Erro clima.";
                }
                else if (final.includes("[WIKI:")) {
                    updateLoading(loadingId, "Wiki...");
                    const t = final.match(/\[WIKI: (.*?)\]/)[1];
                    toolResult = await Tools.wiki(t) || "Sem dados.";
                }
                else if (final.includes("[MEM:")) {
                    const c = final.match(/\[MEM: (.*?)\]/)[1];
                    await DB.add(c);
                    toolResult = "Salvo.";
                }
                else if (final.includes("[YOUTUBE:")) {
                    const t = final.match(/\[YOUTUBE: (.*?)\]/)[1];
                    window.open(`https://www.youtube.com/results?search_query=${encodeURIComponent(t)}`, '_blank');
                    final = `üé¨ YouTube: **${t}**`;
                }
                else if (final.includes("[GOOGLE:")) {
                    const t = final.match(/\[GOOGLE: (.*?)\]/)[1];
                    window.open(`https://www.google.com/search?q=${encodeURIComponent(t)}`, '_blank');
                    final = `üåê Google: **${t}**`;
                }

                // Se houver ferramenta (que n√£o seja PDF pois j√° retornou), continua o fluxo
                if (toolResult) {
                    tempHistory.push({ role: "assistant", content: raw });
                    tempHistory.push({ role: "user", content: `Resultado Sistema: ${toolResult}. Continue.` });
                    const step2 = await engine.chat.completions.create({ messages: tempHistory });
                    final = step2.choices[0].message.content.replace(/<pensamento>.*?<\/pensamento>/s, "").trim();
                }

                removeLoading(loadingId);
                appendBubble('assistant', final);
                speak(final);

                chatHistory.push({ role: "user", content: text });
                chatHistory.push({ role: "assistant", content: final });
                if (chatHistory.length > MAX_HISTORY) chatHistory.splice(1, 2);

            } catch (e) {
                removeLoading(loadingId);
                appendBubble('system', "Erro: " + e.message);
            }
        };

        // --- BANCO DE DADOS ---
        const DB = {
            wakeUp: async () => {
                if (!RENDER_API_URL || isOfflineMode) return false;
                $('status-indicator').innerHTML = '<span class="animate-pulse">‚è≥</span>';
                try {
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 60000); 
                    const res = await fetch(`${RENDER_API_URL}/wake-up`, { signal: controller.signal });
                    clearTimeout(timeoutId);
                    if (res.ok) { 
                        isOnlineDB = true; 
                        $('status-indicator').innerText = "‚óè Online";
                        $('status-indicator').className = "text-[10px] text-green-500 font-bold cursor-pointer";
                        return true; 
                    }
                } catch (e) {}
                isOnlineDB = false;
                $('status-indicator').innerText = "‚óè Local";
                $('status-indicator').className = "text-[10px] text-red-500 font-bold cursor-pointer";
                return false;
            },
            retryConnection: async () => {
                showToast("Reconectando...");
                await DB.wakeUp();
                DB.refreshList();
            },
            add: async (text) => {
                const entry = { content: text, date: new Date().toISOString() };
                if (isOnlineDB && !isOfflineMode) {
                    try { fetch(`${RENDER_API_URL}/memories`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(entry) }); } catch(e){}
                } 
                const local = JSON.parse(localStorage.getItem('neural_local_db') || '[]');
                local.unshift({ ...entry, id: Date.now() });
                localStorage.setItem('neural_local_db', JSON.stringify(local));
                const msg = isOnlineDB ? "Salvo na Nuvem" : "Salvo Localmente";
                showToast(`üíæ ${msg}`);
                DB.refreshList();
            },
            search: async (term) => {
                const local = JSON.parse(localStorage.getItem('neural_local_db') || '[]');
                return local.filter(m => m.content.toLowerCase().includes(term.toLowerCase())).map(m => m.content).slice(0, 3);
            },
            refreshList: async () => {
                const list = $('memory-list');
                let items = JSON.parse(localStorage.getItem('neural_local_db') || '[]');
                if (isOnlineDB && !isOfflineMode) {
                    try {
                        const res = await fetch(`${RENDER_API_URL}/memories`);
                        if(res.ok) items = await res.json();
                    } catch(e) {}
                }
                $('mem-count').innerText = items.length;
                list.innerHTML = items.length ? '' : '<div class="text-center text-gray-500 text-xs mt-10">Vazio</div>';
                
                const dark = userConfig.amoled;
                items.forEach(item => {
                    const el = document.createElement('div');
                    const bgClass = dark ? 'bg-gray-900 border-gray-800 text-gray-300' : 'bg-white border-gray-100 text-gray-700';
                    el.className = `${bgClass} p-3 rounded-lg border shadow-sm mb-2 text-sm`;
                    el.innerHTML = `<div class="font-medium">${item.content}</div><div class="text-[10px] opacity-60 mt-1">${new Date(item.date).toLocaleDateString()}</div>`;
                    list.appendChild(el);
                });
            }
        };

        // --- UI UTILS ---
        function appendBubble(role, text) {
            const box = $('chat-content');
            const div = document.createElement('div');
            const dark = userConfig.amoled;
            
            if (role === 'thought') {
                div.className = "flex w-full mb-2 animate-fade-in";
                div.innerHTML = `<div class="${dark ? 'bg-gray-900 text-gray-500 border-gray-700' : 'bg-gray-100 text-gray-500 border-gray-400'} text-xs italic p-2 rounded-lg border-l-2 max-w-[85%]">üí≠ ${text}</div>`;
            } else if (role === 'system') {
                div.className = "flex w-full justify-center mb-2 animate-fade-in";
                div.innerHTML = `<div class="bg-yellow-500/20 text-yellow-600 text-xs px-3 py-1 rounded-full">${text}</div>`;
            } else {
                const isUser = role === 'user';
                div.className = `flex w-full mb-4 animate-fade-in ${isUser ? 'justify-end' : 'justify-start'}`;
                
                let contentHTML = marked.parse(text);
                
                if (!isUser && (text.includes("```html") || text.includes("```javascript") || text.includes("```js"))) {
                    const codeMatch = text.match(/```(html|javascript|js)([\s\S]*?)```/);
                    if (codeMatch) {
                        const codeType = codeMatch[1] === 'html' ? 'html' : 'js';
                        const codeContent = codeMatch[2];
                        const escapedCode = codeContent.replace(/`/g, '\\`').replace(/"/g, '&quot;');
                        contentHTML += `<button onclick="openCanvas(\`${escapedCode}\`, '${codeType}')" class="mt-2 flex items-center gap-2 bg-gradient-to-r from-green-600 to-emerald-600 text-white px-4 py-2 rounded-lg text-xs font-bold hover:shadow-lg transition-all w-full justify-center"><i data-lucide="play-circle" class="w-4 h-4"></i> Testar no Canvas</button>`;
                    }
                }

                div.innerHTML = `<div class="max-w-[90%] p-3.5 rounded-2xl shadow-sm text-sm leading-relaxed overflow-hidden ${isUser ? 'bg-indigo-600 text-white rounded-tr-sm' : (dark ? 'bg-gray-800 text-gray-200 border-gray-700' : 'bg-white text-gray-800 border-gray-200') + ' border rounded-tl-sm prose prose-sm prose-invert'}">${contentHTML}</div>`;
            }
            box.appendChild(div);
            lucide.createIcons();
            requestAnimationFrame(() => box.scrollTop = box.scrollHeight);
        }

        function showLoading() {
            const id = 'load-' + Date.now();
            const box = $('chat-content');
            const div = document.createElement('div');
            const dark = userConfig.amoled;
            div.id = id;
            div.className = "flex w-full mb-4 animate-fade-in";
            div.innerHTML = `<div class="${dark ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-200'} border px-3 py-2 rounded-2xl text-xs text-gray-400 flex items-center gap-2"><span class="animate-spin">‚öôÔ∏è</span> <span id="${id}-txt">Processando...</span></div>`;
            box.appendChild(div);
            requestAnimationFrame(() => box.scrollTop = box.scrollHeight);
            return id;
        }
        function updateLoading(id, txt) { const el = document.getElementById(id+'-txt'); if(el) el.innerText = txt; }
        function removeLoading(id) { const el = document.getElementById(id); if(el) el.remove(); }
        
        function showToast(msg) { 
            const t = document.createElement('div');
            t.className = "fixed top-20 left-1/2 -translate-x-1/2 bg-gray-900 text-white text-xs px-4 py-2 rounded-full shadow-lg z-50 animate-fade-in";
            t.innerText = msg;
            document.body.appendChild(t);
            setTimeout(() => t.remove(), 2000);
        }

        // --- UTILS & SETTINGS UI ---
        window.toggleSettings = () => { $('settings-modal').classList.toggle('hidden'); loadVoices(); $('input-name').value = userConfig.name; $('select-vibe').value = userConfig.vibe; $('check-tts').checked = userConfig.ttsEnabled; $('check-amoled').checked = userConfig.amoled; };
        
        window.saveSettings = () => { 
            userConfig.name = $('input-name').value;
            userConfig.vibe = $('select-vibe').value;
            userConfig.ttsEnabled = $('check-tts').checked;
            userConfig.voiceIndex = $('select-voice').selectedIndex;
            userConfig.amoled = $('check-amoled').checked;
            
            try {
                localStorage.setItem('neural_user_name', userConfig.name);
                localStorage.setItem('neural_ai_vibe', userConfig.vibe);
                localStorage.setItem('neural_tts', userConfig.ttsEnabled);
                localStorage.setItem('neural_voice_idx', userConfig.voiceIndex);
                localStorage.setItem('neural_amoled', userConfig.amoled);
                showToast("Salvo com sucesso!");
            } catch(e) {
                showToast("Erro ao salvar (Storage bloqueado)");
            }
            
            applyTheme(); updateSystemPrompt(); $('settings-modal').classList.add('hidden');
        };
        
        window.switchTab = (tab) => {
            if (tab === 'chat') {
                $('view-chat').classList.remove('hidden'); $('view-mem').classList.add('hidden');
                $('btn-chat').classList.add('bg-indigo-100', 'text-indigo-700'); $('btn-mem').classList.remove('bg-indigo-100', 'text-indigo-700');
            } else {
                $('view-chat').classList.add('hidden'); $('view-mem').classList.remove('hidden');
                $('btn-mem').classList.add('bg-indigo-100', 'text-indigo-700'); $('btn-chat').classList.remove('bg-indigo-100', 'text-indigo-700');
                DB.refreshList();
            }
        };
        window.triggerFileUpload = () => $('file-upload').click();
        $('input-box').addEventListener('keypress', (e) => { if (e.key === 'Enter') window.sendMessage(); });
        window.onload = initSystem;
    </script>
    <style>
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        ::-webkit-scrollbar { width: 0px; } 
    </style>
</head>
<body class="font-sans antialiased bg-slate-50 text-slate-800 transition-colors duration-300 h-full w-full overflow-hidden flex flex-col">

    <!-- CANVAS MODAL (Com Logs) -->
    <div id="canvas-modal" class="hidden fixed inset-0 z-50 bg-black flex flex-col animate-fade-in">
        <div id="canvas-modal-header" class="h-12 bg-gray-900 flex items-center justify-between px-4 border-b border-gray-800 shrink-0">
            <h3 id="canvas-title" class="text-white text-sm font-bold flex items-center gap-2">
                <i data-lucide="layout" class="w-4 h-4 text-green-400"></i> Canvas Pro
            </h3>
            <div class="flex gap-2">
                <button id="fix-code-btn" onclick="fixCanvasCode()" class="hidden bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-xs font-bold flex items-center gap-1">
                    <i data-lucide="wrench" class="w-3 h-3"></i> Corrigir Erro
                </button>
                <button onclick="closeCanvas()" class="text-gray-400 hover:text-white p-2">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
        </div>
        <!-- √Årea de Preview -->
        <div id="canvas-container" class="flex-1 w-full bg-white relative"></div>
        <!-- √Årea de Logs -->
        <div class="h-32 bg-gray-950 border-t border-gray-800 p-2 overflow-y-auto font-mono text-[10px] shrink-0" id="canvas-console">
            <div class="text-gray-600 italic">Console pronto...</div>
        </div>
    </div>

    <!-- SETTINGS MODAL -->
    <div id="settings-modal" class="hidden absolute inset-0 z-40 bg-black/50 flex items-center justify-center p-4 backdrop-blur-sm modal-bg">
        <div class="bg-white w-full max-w-xs rounded-2xl p-6 shadow-2xl modal-bg">
            <h2 class="text-lg font-bold mb-4">Ajustes</h2>
            <label class="block text-xs font-bold text-gray-500 mb-1">Nome</label>
            <input id="input-name" type="text" class="w-full bg-gray-100 rounded p-2 text-sm mb-3 text-black">
            <label class="block text-xs font-bold text-gray-500 mb-1">Persona</label>
            <select id="select-vibe" class="w-full bg-gray-100 rounded p-2 text-sm mb-3 text-black">
                <option value="Assistente Padr√£o">Padr√£o</option>
                <option value="Jarvis">Jarvis</option>
                <option value="Amigo">Amigo</option>
            </select>
            <label class="block text-xs font-bold text-gray-500 mb-1">Voz</label>
            <select id="select-voice" class="w-full bg-gray-100 rounded p-2 text-sm mb-3 text-xs text-black"><option>Carregando...</option></select>
            <div class="flex items-center justify-between mb-4"><span class="text-sm">Fala Ativa</span><input id="check-tts" type="checkbox" class="w-5 h-5 accent-indigo-600"></div>
            <div class="flex items-center justify-between mb-6"><span class="text-sm">Modo AMOLED</span><input id="check-amoled" type="checkbox" class="w-5 h-5 accent-black"></div>
            <button onclick="saveSettings()" class="w-full bg-indigo-600 text-white py-2 rounded-xl font-bold">Salvar</button>
            <button onclick="toggleSettings()" class="w-full mt-2 text-gray-400 text-xs">Fechar</button>
        </div>
    </div>

    <!-- LOADING SCREEN -->
    <div id="loading-screen" class="absolute inset-0 z-50 bg-white flex flex-col items-center justify-center p-8 transition-opacity duration-500">
        <div class="w-20 h-20 mb-6 rounded-3xl bg-indigo-600 flex items-center justify-center shadow-xl animate-bounce">
            <i data-lucide="cpu" class="text-white w-10 h-10"></i>
        </div>
        <h2 class="text-2xl font-bold text-gray-800 mb-1">NeuralOS <span class="text-indigo-600">v7.5</span></h2>
        <p id="status-text" class="text-gray-400 text-xs font-mono mb-8">Iniciando...</p>
        <div class="w-48 h-1.5 bg-gray-100 rounded-full overflow-hidden">
            <div id="loading-bar" class="h-full bg-indigo-600 transition-all duration-300 w-0"></div>
        </div>
    </div>

    <!-- MAIN APP STRUCTURE -->
    <div id="main-app-container" class="flex-1 flex flex-col relative overflow-hidden max-w-md mx-auto w-full h-full border-x border-gray-100 shadow-2xl bg-white">
        <header class="h-14 backdrop-blur border-b border-gray-100 flex items-center justify-between px-4 shrink-0 z-20 transition-colors" id="main-header">
            <div class="flex items-center gap-3">
                <button onclick="toggleSettings()" class="p-2 rounded-full hover:bg-gray-200/50"><i data-lucide="settings" class="w-5 h-5 text-gray-500"></i></button>
                <div>
                    <h1 class="font-bold text-sm">NeuralOS</h1>
                    <div id="status-indicator" onclick="DB.retryConnection()" class="text-[10px] text-gray-400 font-medium cursor-pointer">‚óè Conectando...</div>
                </div>
            </div>
            <div class="flex bg-gray-100/50 p-1 rounded-full">
                <button id="btn-chat" onclick="switchTab('chat')" class="px-4 py-1.5 rounded-full text-xs font-bold bg-indigo-100 text-indigo-700 transition-all">Chat</button>
                <button id="btn-mem" onclick="switchTab('mem')" class="px-4 py-1.5 rounded-full text-xs font-bold text-gray-500 hover:text-indigo-600 transition-all">Banco</button>
            </div>
        </header>

        <!-- CHAT -->
        <div id="view-chat" class="flex-1 flex flex-col relative overflow-hidden h-full">
            <div id="chat-box" class="flex-1 overflow-y-auto scroll-smooth p-4">
                <div id="chat-content" class="pt-2 space-y-4">
                    <div class="flex justify-center">
                        <span class="text-[10px] opacity-50 px-3 py-1 rounded-full border flex items-center gap-1"><i data-lucide="code" class="w-3 h-3"></i> Dev Mode Ativo</span>
                    </div>
                </div>
            </div>
            
            <div id="input-container" class="w-full p-4 bg-white z-10 transition-colors shrink-0 border-t border-gray-100">
                <div id="input-wrapper" class="flex items-center gap-2 border p-1.5 pl-2 rounded-full shadow-sm bg-white">
                    <button id="attach-btn" onclick="triggerFileUpload()" class="w-9 h-9 rounded-full text-gray-400 hover:text-indigo-600 flex items-center justify-center transition-colors"><i data-lucide="paperclip" class="w-5 h-5"></i></button>
                    <input type="file" id="file-upload" multiple class="hidden" onchange="handleFiles()">
                    <input id="input-box" type="text" class="flex-1 bg-transparent text-sm focus:outline-none placeholder-gray-400 text-gray-800" placeholder="Digite...">
                    <button id="mic-btn" onclick="window.toggleMic && window.toggleMic()" class="w-9 h-9 rounded-full bg-gray-100 text-gray-500 hover:bg-red-100 hover:text-red-500 flex items-center justify-center transition-colors"><i data-lucide="mic" class="w-5 h-5"></i></button>
                    <button onclick="window.sendMessage()" class="w-10 h-10 bg-indigo-600 hover:bg-indigo-500 rounded-full flex items-center justify-center text-white shadow-lg transition-transform active:scale-95"><i data-lucide="arrow-up" class="w-5 h-5"></i></button>
                </div>
            </div>
        </div>

        <!-- MEMORY -->
        <div id="view-mem" class="hidden flex-1 flex flex-col overflow-hidden h-full">
            <div class="p-4 border-b flex justify-between items-center shrink-0">
                <h3 class="font-bold text-xs uppercase tracking-wider opacity-70">Mem√≥ria (<span id="mem-count">0</span>)</h3>
                <div class="flex gap-2">
                    <button onclick="DB.refreshList()" class="p-2 rounded-full hover:bg-gray-100"><i data-lucide="refresh-cw" class="w-4 h-4"></i></button>
                </div>
            </div>
            <div id="memory-list" class="flex-1 overflow-y-auto p-4"></div>
        </div>
    </div>

</body>
</html>
