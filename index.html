<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, interactive-widget=resizes-content">
    <title>IA Mobile Pro - Poco Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/12.0.0/marked.min.js"></script>
    
    <script type="module">
        import * as webllm from "https://esm.run/@mlc-ai/web-llm";

        // --- CONFIGURAÃ‡ÃƒO ---
        // Llama 3.2 3B: O equilÃ­brio entre inteligÃªncia e, agora com ajustes, performance.
        const selectedModel = "Llama-3.2-3B-Instruct-q4f16_1-MLC";

        let engine = null;
        let chatHistory = [];
        const MAX_HISTORY = 6; // OTIMIZAÃ‡ÃƒO: MantÃ©m apenas as Ãºltimas 6 trocas para evitar lentidÃ£o

        const $ = (id) => document.getElementById(id);

        async function initChat() {
            $('status-text').innerText = "Iniciando GPU...";
            $('error-log').classList.add('hidden');
            $('loading-bar').style.width = "10%";
            
            const initProgressCallback = (report) => {
                $('status-text').innerText = report.text;
                if(report.text.includes("Fetching param cache")) {
                    const match = report.text.match(/(\d+)%/);
                    if (match) $('loading-bar').style.width = match[1] + "%";
                } else if (report.text.includes("Loading model")) {
                     $('loading-bar').style.width = "85%";
                } else if (report.text.includes("Finish")) {
                     $('loading-bar').style.width = "100%";
                }
            };

            try {
                if (!navigator.gpu) {
                    throw new Error("Seu navegador nÃ£o suporta WebGPU. Use Chrome atualizado.");
                }

                engine = await webllm.CreateMLCEngine(
                    selectedModel,
                    { 
                        initProgressCallback: initProgressCallback,
                        logLevel: "WARN" // Menos logs para economizar processamento
                    }
                );
                
                // Warm-up (Aquecimento rÃ¡pido)
                await engine.chat.completions.create({
                    messages: [{ role: "user", content: "oi" }],
                    max_tokens: 1,
                });

                setTimeout(() => $('loading-container').style.display = 'none', 500);
                $('send-btn').disabled = false;
                
                // --- PROMPT OTIMIZADO ---
                // Mais direto para evitar que a IA pense demais antes de comeÃ§ar a escrever
                const systemPrompt = `
VocÃª Ã© uma IA assistente especialista.
DIRETRIZES:
1. Responda em PortuguÃªs do Brasil.
2. Seja direta e prestativa.
3. NÃ£o divague desnecessariamente.

FERRAMENTAS:
- [BUSCAR: termo]
- [SALVAR: dados]
`;
                // Inicializa histÃ³rico apenas com o System Prompt
                chatHistory = [{ role: "system", content: systemPrompt }];

            } catch (err) {
                $('loading-container').style.display = 'flex';
                $('status-text').innerText = "Erro.";
                $('error-log').innerHTML = `<div class="text-[10px] text-red-300">${err.message}</div><button onclick="window.clearCache()" class="mt-2 bg-red-600 text-white px-4 py-2 rounded">Reiniciar</button>`;
                $('error-log').classList.remove('hidden');
            }
        }

        window.clearCache = async () => {
             if(confirm("Reiniciar tudo?")) {
                try {
                    const cacheKeys = await caches.keys();
                    for (const key of cacheKeys) { if (key.includes("webllm")) await caches.delete(key); }
                    const dbs = await window.indexedDB.databases();
                    for (const db of dbs) { if (db.name?.includes("webllm")) window.indexedDB.deleteDatabase(db.name); }
                    localStorage.clear();
                    window.location.reload();
                } catch (e) { alert(e.message); }
             }
        }

        function appendMessage(role, text, id = null) {
            const chatBox = $('chat-box');
            let div = id ? document.getElementById(id) : null;
            
            if (!div) {
                div = document.createElement('div');
                if (id) div.id = id;
                div.className = `p-4 rounded-2xl max-w-[90%] mb-4 text-base leading-relaxed shadow-sm animate-fade-in ${
                    role === 'user' 
                    ? 'bg-blue-600 text-white self-end ml-auto rounded-tr-none' 
                    : 'bg-gray-800 border border-gray-700 text-gray-100 self-start rounded-tl-none prose prose-invert max-w-none'
                }`;
                chatBox.appendChild(div);
            }

            if (role === 'assistant') div.innerHTML = marked.parse(text);
            else div.innerText = text;
            
            chatBox.scrollTo({ top: chatBox.scrollHeight, behavior: 'smooth' });
            return div;
        }

        // FunÃ§Ã£o para gerenciar o tamanho da memÃ³ria e evitar lentidÃ£o
        function manageHistory(newRole, newContent) {
            chatHistory.push({ role: newRole, content: newContent });
            
            // MantÃ©m sempre o System Prompt (Ã­ndice 0) + as Ãºltimas MAX_HISTORY mensagens
            if (chatHistory.length > MAX_HISTORY + 1) {
                // Remove a mensagem mais antiga (pula o Ã­ndice 0 que Ã© o system)
                chatHistory.splice(1, 1);
            }
        }

        window.sendMessage = async () => {
            const input = $('user-input');
            const text = input.value.trim();
            if (!text || !engine) return;

            appendMessage('user', text);
            input.value = '';
            
            // Adiciona ao histÃ³rico com gerenciamento de tamanho
            manageHistory("user", text);

            const responseId = 'msg-' + Date.now();
            // Indicador visual mais claro de processamento
            appendMessage('assistant', '<span class="flex items-center gap-2 text-blue-300"><span class="w-2 h-2 bg-blue-400 rounded-full animate-bounce"></span> Gerando...</span>', responseId);

            try {
                // OTIMIZAÃ‡ÃƒO: Removido repetition_penalty e temperature ajustada
                const chunks = await engine.chat.completions.create({
                    messages: chatHistory,
                    temperature: 0.7, 
                    max_tokens: 1024, // Limite seguro para evitar loops infinitos
                    stream: true
                });

                let fullResponse = "";
                
                for await (const chunk of chunks) {
                    const content = chunk.choices[0]?.delta?.content || "";
                    fullResponse += content;
                    
                    // Atualiza a tela a cada chunk para sensaÃ§Ã£o de velocidade
                    if (!fullResponse.includes("[BUSCAR:") && !fullResponse.includes("[SALVAR:")) {
                        appendMessage('assistant', fullResponse, responseId);
                    }
                }

                if (fullResponse.includes("[BUSCAR:")) {
                     document.getElementById(responseId).remove();
                     handleSearchTool(fullResponse);
                } else if (fullResponse.includes("[SALVAR:")) {
                     document.getElementById(responseId).remove();
                     handleSaveTool(fullResponse);
                } else {
                    // Adiciona resposta final ao histÃ³rico
                    manageHistory("assistant", fullResponse);
                }

            } catch (err) {
                appendMessage('assistant', "Erro: " + err.message);
            }
        };

        async function handleSearchTool(command) {
            const query = command.match(/\[BUSCAR: (.*?)\]/)[1];
            appendMessage('assistant', `ðŸ”Ž <i>Buscando dados sobre: "${query}"...</i>`);
            setTimeout(async () => {
                const fakeResult = `(Simulado) Dados encontrados sobre ${query}.`;
                // Adiciona resultado como sistema, mas sem estourar o histÃ³rico
                manageHistory("system", `[RESULTADO]: "${fakeResult}"`);
                
                const followUp = await engine.chat.completions.create({ messages: chatHistory });
                const finalText = followUp.choices[0].message.content;
                
                appendMessage('assistant', finalText);
                manageHistory("assistant", finalText);
            }, 300);
        }

        async function handleSaveTool(command) {
            const data = command.match(/\[SALVAR: (.*?)\]/)[1];
            const savedItems = JSON.parse(localStorage.getItem('ia_memoria') || '[]');
            savedItems.push({ data: new Date().toISOString(), content: data });
            localStorage.setItem('ia_memoria', JSON.stringify(savedItems));
            appendMessage('assistant', `ðŸ’¾ <i>Memorizado.</i>`);
            manageHistory("assistant", "InformaÃ§Ã£o salva com sucesso.");
        }

        $('user-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') window.sendMessage();
        });

        window.onload = initChat;
    </script>
    <style>
        @keyframes fade-in { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fade-in 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        
        body { 
            height: 100dvh; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden; 
            background-color: #111827;
        }
        
        main {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 100px; 
        }

        footer {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: #111827;
            padding-bottom: env(safe-area-inset-bottom, 20px);
            z-index: 50;
        }
    </style>
</head>
<body class="text-gray-100 font-sans">

    <!-- Header Fixo -->
    <header class="bg-gray-900/95 backdrop-blur shadow-md p-3 border-b border-gray-800 flex justify-between items-center z-50 h-14 w-full">
        <div class="flex items-center gap-3">
            <div class="relative">
                <div class="w-2.5 h-2.5 rounded-full bg-blue-500 animate-pulse"></div>
                <div class="absolute inset-0 w-2.5 h-2.5 rounded-full bg-blue-500 blur-sm animate-pulse"></div>
            </div>
            <h1 class="font-bold text-base tracking-wide">Neural <span class="text-blue-400">Pro</span></h1>
        </div>
        <div class="px-2 py-1 bg-gray-800 rounded border border-gray-700 text-[10px] text-gray-400 font-mono">
            3B Otimizado
        </div>
    </header>

    <!-- Loading -->
    <div id="loading-container" class="absolute inset-0 bg-gray-900 z-[60] flex flex-col items-center justify-center p-6 text-center">
        <div class="w-full max-w-sm bg-gray-800 rounded-2xl p-6 shadow-2xl border border-gray-700 relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-600 via-purple-600 to-blue-600"></div>
            <h2 class="text-xl font-bold mb-2 text-white">Carregando IA</h2>
            <div class="w-full bg-gray-900 h-2 rounded-full overflow-hidden mb-2 border border-gray-600">
                <div id="loading-bar" class="h-full bg-blue-500 transition-all duration-300" style="width: 0%"></div>
            </div>
            <p id="status-text" class="text-blue-300 text-xs font-mono mt-2">Iniciando...</p>
            <div id="error-log" class="hidden mt-4 p-2 bg-red-900/30 rounded text-left max-h-40 overflow-auto"></div>
        </div>
    </div>

    <!-- Chat -->
    <main id="chat-box" class="p-4 space-y-4 w-full max-w-2xl mx-auto scroll-smooth">
        <div class="p-4 rounded-2xl bg-gray-800 border border-gray-700 text-gray-200 shadow-lg mt-4">
            <p class="mb-1 text-sm font-bold text-blue-400">âš¡ Sistema Otimizado</p>
            <p class="text-sm opacity-90">
                Modelo 3B ajustado para maior velocidade. MemÃ³ria de curto prazo ativada (Ãºltimas 6 mensagens).
            </p>
        </div>
    </main>

    <!-- Footer Input Fixo e Seguro -->
    <footer class="border-t border-gray-800">
        <div class="max-w-2xl mx-auto p-3 pb-4 flex gap-2 items-center">
            <input type="text" id="user-input" 
                class="flex-1 bg-gray-800 text-white rounded-full px-5 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:bg-gray-700 transition-all text-base border border-gray-700"
                placeholder="Digite sua mensagem..." autocomplete="off">
                
            <button onclick="window.sendMessage()" id="send-btn" disabled
                class="bg-blue-600 active:bg-blue-700 text-white w-12 h-12 rounded-full flex items-center justify-center shadow-lg shrink-0">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M15.854.146a.5.5 0 0 1 .11.54l-5.819 14.547a.75.75 0 0 1-1.329.124l-3.178-4.995L.643 7.184a.75.75 0 0 1 .124-1.33L15.314.037a.5.5 0 0 1 .54.11ZM6.636 10.07l2.761 4.338L14.13 2.576 6.636 10.07Zm6.787-8.201L1.591 6.602l4.339 2.76 7.494-7.493Z"/>
                </svg>
            </button>
        </div>
    </footer>

</body>
</html>
