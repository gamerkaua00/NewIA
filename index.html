<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, interactive-widget=resizes-content">
    <title>IA Mobile Pro - Ultimate</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/12.0.0/marked.min.js"></script>
    
    <script type="module">
        import * as webllm from "https://esm.run/@mlc-ai/web-llm";

        // --- CONFIGURA√á√ÉO DE ALTO DESEMPENHO ---
        // Modelo 3B Instruct: O melhor equil√≠brio para mobile potente (12GB RAM).
        const selectedModel = "Llama-3.2-3B-Instruct-q4f16_1-MLC";

        let engine = null;
        let chatHistory = [];
        // Aumentado para 15: Seu celular aguenta mais contexto, o que melhora a intelig√™ncia na conversa longa.
        const MAX_HISTORY = 15; 

        const $ = (id) => document.getElementById(id);

        async function initChat() {
            $('status-text').innerText = "Inicializando Neural Engine...";
            $('loading-bar').style.width = "10%";
            
            const initProgressCallback = (report) => {
                $('status-text').innerText = report.text;
                if(report.text.includes("Fetching")) {
                    const match = report.text.match(/(\d+)%/);
                    if (match) $('loading-bar').style.width = match[1] + "%";
                } else if (report.text.includes("Loading")) {
                     $('loading-bar').style.width = "85%";
                } else if (report.text.includes("Finish")) {
                     $('loading-bar').style.width = "100%";
                }
            };

            try {
                if (!navigator.gpu) throw new Error("WebGPU n√£o detectado.");

                engine = await webllm.CreateMLCEngine(
                    selectedModel,
                    { 
                        initProgressCallback: initProgressCallback,
                        logLevel: "WARN" 
                    }
                );
                
                // Aquecimento silencioso para evitar lag na primeira mensagem
                await engine.chat.completions.create({
                    messages: [{ role: "user", content: "hi" }],
                    max_tokens: 1,
                });

                setTimeout(() => $('loading-container').style.opacity = '0', 500);
                setTimeout(() => $('loading-container').style.display = 'none', 1000);
                $('send-btn').disabled = false;
                
                // --- PROMPT "ESPECIALISTA" ---
                const systemPrompt = `
Voc√™ √© uma Intelig√™ncia Artificial Avan√ßada.
- Seu objetivo √© fornecer respostas precisas, completas e inteligentes.
- Responda SEMPRE em Portugu√™s do Brasil.
- Use formata√ß√£o (negrito, listas) para facilitar a leitura.
- Se a pergunta for complexa, explique o racioc√≠nio.

FERRAMENTAS:
- [BUSCAR: termo] para fatos da internet.
- [SALVAR: dados] para mem√≥ria de longo prazo.
`;
                chatHistory = [{ role: "system", content: systemPrompt }];

            } catch (err) {
                $('loading-bar').classList.remove('bg-blue-500');
                $('loading-bar').classList.add('bg-red-500');
                $('status-text').innerText = "Erro: " + err.message;
                $('status-text').classList.add('text-red-400');
            }
        }

        // Fun√ß√£o para gerenciar hist√≥rico (Mem√≥ria Deslizante)
        function manageHistory(newRole, newContent) {
            chatHistory.push({ role: newRole, content: newContent });
            if (chatHistory.length > MAX_HISTORY + 1) {
                chatHistory.splice(1, 1); // Remove a mais antiga, mant√©m o System Prompt
            }
        }

        function appendMessage(role, text, id = null) {
            const chatBox = $('chat-box');
            let div = id ? document.getElementById(id) : null;
            
            if (!div) {
                div = document.createElement('div');
                if (id) div.id = id;
                // Layout Moderno estilo App de Mensagem
                const isUser = role === 'user';
                div.className = `flex w-full mb-4 ${isUser ? 'justify-end' : 'justify-start'} animate-fade-in`;
                
                const bubble = document.createElement('div');
                bubble.className = `max-w-[85%] p-4 rounded-2xl shadow-sm text-[15px] leading-relaxed ${
                    isUser 
                    ? 'bg-blue-600 text-white rounded-tr-sm' 
                    : 'bg-[#1f2937] text-gray-100 border border-gray-700 rounded-tl-sm prose prose-invert max-w-none'
                }`;
                
                div.appendChild(bubble);
                chatBox.appendChild(div);
                
                // Salva refer√™ncia do bubble para inserir HTML depois
                div.bubbleContent = bubble; 
            }

            // Renderiza Markdown ou Texto
            if (role === 'assistant') {
                div.bubbleContent.innerHTML = marked.parse(text);
            } else {
                div.bubbleContent.innerText = text;
            }
            
            // Scroll suave para o fim
            chatBox.scrollTo({ top: chatBox.scrollHeight, behavior: 'smooth' });
            return div;
        }

        window.sendMessage = async () => {
            const input = $('user-input');
            const text = input.value.trim();
            if (!text || !engine) return;

            // 1. Mostra mensagem do usu√°rio
            appendMessage('user', text);
            input.value = '';
            manageHistory("user", text);

            // 2. Mostra indicador de "Processando"
            const loadingId = 'loading-' + Date.now();
            const chatBox = $('chat-box');
            const loadingDiv = document.createElement('div');
            loadingDiv.id = loadingId;
            loadingDiv.className = 'flex w-full mb-4 justify-start animate-fade-in';
            loadingDiv.innerHTML = `
                <div class="bg-[#1f2937] border border-gray-700 p-4 rounded-2xl rounded-tl-sm flex items-center gap-3">
                    <div class="flex gap-1">
                        <span class="w-2 h-2 bg-blue-500 rounded-full animate-bounce"></span>
                        <span class="w-2 h-2 bg-blue-500 rounded-full animate-bounce delay-100"></span>
                        <span class="w-2 h-2 bg-blue-500 rounded-full animate-bounce delay-200"></span>
                    </div>
                    <span class="text-xs text-gray-400 font-mono">Gerando resposta completa...</span>
                </div>
            `;
            chatBox.appendChild(loadingDiv);
            chatBox.scrollTo({ top: chatBox.scrollHeight, behavior: 'smooth' });

            try {
                // 3. GERA√á√ÉO SEM STREAMING (INSTANT√ÇNEA AO FINAL)
                // stream: false faz a IA processar tudo internamente e devolver s√≥ quando estiver pronto.
                // Isso elimina a sensa√ß√£o de "travamento" letra por letra.
                const reply = await engine.chat.completions.create({
                    messages: chatHistory,
                    temperature: 0.7,
                    max_tokens: 2048,
                    stream: false // <--- O SEGREDO DA FLUIDEZ
                });

                const fullResponse = reply.choices[0].message.content;

                // 4. Remove indicador de loading e mostra resposta
                loadingDiv.remove();

                // Verifica ferramentas
                if (fullResponse.includes("[BUSCAR:")) {
                     handleSearchTool(fullResponse);
                } else if (fullResponse.includes("[SALVAR:")) {
                     handleSaveTool(fullResponse);
                } else {
                    appendMessage('assistant', fullResponse);
                    manageHistory("assistant", fullResponse);
                }

            } catch (err) {
                loadingDiv.remove();
                appendMessage('assistant', "Erro no processamento: " + err.message);
            }
        };

        // --- Ferramentas ---
        async function handleSearchTool(command) {
            const query = command.match(/\[BUSCAR: (.*?)\]/)[1];
            // Mostra um indicador de "sistema" tempor√°rio
            const sysId = 'sys-' + Date.now();
            appendMessage('assistant', `üîé <i>Buscando informa√ß√µes sobre: <b>${query}</b>...</i>`, sysId);
            
            setTimeout(async () => {
                const fakeResult = `(Simulado) Encontrei informa√ß√µes relevantes sobre ${query}. (Aqui entraria o resumo do Google).`;
                
                // Remove a mensagem de "Buscando..." para limpar a tela ou mant√©m como log
                // Vamos manter e adicionar a resposta abaixo
                manageHistory("system", `[RESULTADO BUSCA]: "${fakeResult}"`);
                
                // Pede para a IA responder com base na busca
                const followUp = await engine.chat.completions.create({ 
                    messages: chatHistory, 
                    stream: false 
                });
                const finalText = followUp.choices[0].message.content;
                
                appendMessage('assistant', finalText);
                manageHistory("assistant", finalText);
            }, 800);
        }

        async function handleSaveTool(command) {
            const data = command.match(/\[SALVAR: (.*?)\]/)[1];
            const savedItems = JSON.parse(localStorage.getItem('ia_memoria') || '[]');
            savedItems.push({ data: new Date().toISOString(), content: data });
            localStorage.setItem('ia_memoria', JSON.stringify(savedItems));
            
            appendMessage('assistant', `‚úÖ Informa√ß√£o salva na mem√≥ria.`);
            manageHistory("assistant", "Confirmo que salvei a informa√ß√£o.");
        }

        $('user-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') window.sendMessage();
        });

        window.onload = initChat;
    </script>
    <style>
        /* Anima√ß√µes e Utilit√°rios */
        @keyframes fade-in { 
            from { opacity: 0; transform: translateY(10px); } 
            to { opacity: 1; transform: translateY(0); } 
        }
        .animate-fade-in { animation: fade-in 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94) both; }
        
        .delay-100 { animation-delay: 0.1s; }
        .delay-200 { animation-delay: 0.2s; }

        /* Estiliza√ß√£o Markdown */
        .prose strong { color: #fff; font-weight: 600; }
        .prose ul { padding-left: 1.2em; list-style-type: disc; margin: 0.5em 0; }
        .prose li { margin-bottom: 0.2em; }
        .prose p { margin-bottom: 0.8em; }
        .prose p:last-child { margin-bottom: 0; }
        .prose h1, .prose h2, .prose h3 { color: #93c5fd; font-weight: bold; margin-top: 1em; margin-bottom: 0.5em; }
        
        /* Layout Mobile Fullscreen */
        body { 
            background-color: #111827; 
            background-image: radial-gradient(circle at 50% 0%, #1f2937 0%, #111827 50%);
            height: 100dvh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
    </style>
</head>
<body class="text-gray-100 font-sans antialiased selection:bg-blue-500 selection:text-white">

    <!-- Header Fixo Moderno -->
    <header class="bg-[#111827]/80 backdrop-blur-xl border-b border-gray-800 z-50 h-16 shrink-0 flex items-center justify-between px-4 absolute top-0 w-full">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-full bg-gradient-to-br from-blue-600 to-purple-600 flex items-center justify-center shadow-lg shadow-blue-900/20">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="white" viewBox="0 0 16 16">
                    <path d="M6 12.796V3.204L11.481 8 6 12.796zm.659.753 5.48-4.796a1 1 0 0 0 0-1.506L6.66 2.451C6.011 1.885 5 2.345 5 3.204v9.592a1 1 0 0 0 1.659.753z"/>
                </svg>
            </div>
            <div>
                <h1 class="font-bold text-lg tracking-tight text-white">Neural<span class="text-blue-500">Mind</span></h1>
                <p class="text-[10px] text-gray-400 font-medium uppercase tracking-wider">Ultimate 3B ‚Ä¢ 12GB RAM</p>
            </div>
        </div>
        
        <!-- Bot√£o de Config/Limpeza -->
        <button onclick="if(confirm('Limpar toda mem√≥ria da IA e cache?')) window.localStorage.clear() || window.location.reload()" class="p-2 text-gray-400 hover:text-white transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2z"/>
                <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466"/>
            </svg>
        </button>
    </header>

    <!-- Overlay de Loading (S√≥ aparece no in√≠cio) -->
    <div id="loading-container" class="absolute inset-0 bg-[#111827] z-[60] flex flex-col items-center justify-center p-8 transition-opacity duration-700">
        <div class="w-20 h-20 mb-6 rounded-full bg-blue-500/10 flex items-center justify-center relative">
            <div class="absolute inset-0 border-4 border-blue-500/30 rounded-full animate-spin"></div>
            <div class="absolute inset-0 border-t-4 border-blue-500 rounded-full animate-spin"></div>
            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="#60a5fa" viewBox="0 0 16 16">
                <path d="M8.186 1.113a.5.5 0 0 0-.372 0L1.846 3.5l2.404.961L10.404 2l-2.218-.887zm3.564 1.426L5.596 5 8 5.961 14.154 3.5l-2.404-.961zm3.25 1.7-6.5 2.6v7.922l6.5-2.6V4.24zM7.5 14.762V6.838L1 4.239v7.923l6.5 2.6zM7.443.184a1.5 1.5 0 0 1 1.114 0l7.129 2.852A.5.5 0 0 1 16 3.5v8.662a1 1 0 0 1-.629.928l-7.185 2.874a.5.5 0 0 1-.372 0L.63 13.09a1 1 0 0 1-.63-.928V3.5a.5.5 0 0 1 .314-.464L7.443.184z"/>
            </svg>
        </div>
        <h2 class="text-2xl font-bold text-white mb-2">Carregando IA</h2>
        <p id="status-text" class="text-blue-300/80 text-sm font-mono mb-6">Preparando motores...</p>
        
        <div class="w-full max-w-[200px] h-1.5 bg-gray-800 rounded-full overflow-hidden">
            <div id="loading-bar" class="h-full bg-blue-500 transition-all duration-300" style="width: 0%"></div>
        </div>
    </div>

    <!-- √Årea de Chat -->
    <main id="chat-box" class="flex-1 overflow-y-auto px-4 pt-20 pb-28 w-full max-w-3xl mx-auto scroll-smooth">
        <!-- Mensagem de Boas Vindas Discreta -->
        <div class="flex justify-center mb-6 mt-4">
            <span class="bg-blue-900/20 text-blue-300 text-xs py-1 px-3 rounded-full border border-blue-500/20 font-medium">
                Mem√≥ria Expandida Ativa ‚Ä¢ Llama 3.2 3B
            </span>
        </div>
    </main>

    <!-- √Årea de Input Flutuante -->
    <footer class="fixed bottom-0 left-0 w-full p-4 z-50 bg-gradient-to-t from-[#111827] via-[#111827] to-transparent pb-[env(safe-area-inset-bottom,20px)]">
        <div class="max-w-3xl mx-auto relative">
            <div class="absolute inset-0 bg-blue-500/5 blur-xl rounded-full"></div>
            <div class="relative flex items-end gap-2 bg-[#1f2937] border border-gray-700 p-2 rounded-[24px] shadow-2xl">
                <input type="text" id="user-input" 
                    class="w-full bg-transparent text-white px-4 py-3 max-h-32 focus:outline-none placeholder-gray-500 text-[16px]"
                    placeholder="Digite sua mensagem..." autocomplete="off">
                
                <button onclick="window.sendMessage()" id="send-btn" disabled
                    class="bg-blue-600 hover:bg-blue-500 active:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed text-white w-12 h-12 rounded-full flex items-center justify-center transition-all shadow-lg shrink-0 mb-px mr-px">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16" class="ml-0.5">
                        <path d="M15.854.146a.5.5 0 0 1 .11.54l-5.819 14.547a.75.75 0 0 1-1.329.124l-3.178-4.995L.643 7.184a.75.75 0 0 1 .124-1.33L15.314.037a.5.5 0 0 1 .54.11ZM6.636 10.07l2.761 4.338L14.13 2.576 6.636 10.07Zm6.787-8.201L1.591 6.602l4.339 2.76 7.494-7.493Z"/>
                    </svg>
                </button>
            </div>
        </div>
    </footer>

</body>
</html>
